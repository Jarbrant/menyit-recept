<!-- ============================================================
     FIL: pages/meal-recipe-detail.html  (HEL FIL)
     Sida 4: M√•ltidsrecept detalj / arbetsyta

     PATCH v2:
       - L√§s ?id= och ladda m√•ltidsrecept fr√•n FEJKDATA (assets/js/app.js)
       - Visa underrecept + ingredienser (s√∂k filtrerar)
       - NYTT: B√§st f√∂re per ingrediens (datumf√§lt)
       - NYTT: Tydlig tillagning per delrecept (flikar: √ñversikt + varje underrecept)
       - Klick p√• underrecept -> √∂ppnar r√§tt tillagningsflik
       - S√∂k ligger i hero/arbetsyta (inte i topbar)
       - Hj√§lp-popover i topbar
     Policy: statisk GitHub Pages, inga externa libs, XSS-safe (textContent)
============================================================ -->
<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kostdata ‚Äî M√•ltidsrecept detalj</title>
  <link rel="stylesheet" href="../assets/css/main.css" />
</head>
<body>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <button class="backBtn" id="backBtn" title="Tillbaka" aria-label="Tillbaka">‚Üê</button>
        <div>
          <div class="pageTitle">M√•ltidsrecept</div>
          <div class="muted small" id="subtitle">Detaljvy</div>
        </div>
      </div>

      <div class="centerSlot"></div>

      <div class="rightSlot" style="position:relative;">
        <button class="btn" id="helpBtn" type="button" aria-haspopup="dialog" aria-expanded="false">Hj√§lp</button>
        <a class="btn" href="./recipes.html" title="Receptlista">Recept</a>
        <button class="btn" id="climateBtn">Klimat & n√§ring</button>
        <button class="btn btnPrimary" id="saveBtn">Spara</button>

        <!-- Hj√§lpruta (popover) -->
        <div id="helpPop"
             class="card"
             role="dialog"
             aria-label="Hj√§lp"
             style="
               display:none;
               position:absolute;
               right:0;
               top:48px;
               width:min(380px, 92vw);
               padding:14px;
               box-shadow: var(--shadow2);
               z-index: 60;">
          <div class="flexBetween">
            <div style="font-weight:900;">Snabbhj√§lp</div>
            <button class="iconBtn" id="helpClose" type="button" aria-label="St√§ng hj√§lp">‚úï</button>
          </div>

          <div class="muted small mt12">
            <div><span class="kbd">/</span> fokuserar s√∂k</div>
            <div><span class="kbd">Esc</span> st√§nger panel</div>
          </div>

          <hr class="hr" />

          <div style="font-weight:900; margin-bottom:6px;">S√• funkar sidan</div>
          <ul class="muted small" style="margin:0 0 0 18px;">
            <li>Sidan √∂ppnas med <span class="kbd">?id=mrX</span> fr√•n Receptlistan.</li>
            <li>Du ser underrecept + ingredienser i listan.</li>
            <li>S√∂k filtrerar ingredienslistan.</li>
            <li>Tillagning √§r uppdelad per underrecept (flikar).</li>
            <li>Klimat & n√§ring √∂ppnas i h√∂gerpanel.</li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- HERO / arbetsyta -->
    <section class="hero">
      <h1 class="heroTitle" id="h1">M√•ltidsrecept</h1>
      <p class="heroSub" id="hSub">Arbetsyta f√∂r m√•ltiden. Underrecept visas tydligt.</p>

      <!-- S√∂k h√§r (inte topbar) -->
      <div class="searchWrap" style="max-width:920px; width:100%; margin-top:12px;">
        <svg class="searchIcon" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M10 4a6 6 0 1 1 3.87 10.58l4.28 4.28-1.42 1.42-4.28-4.28A6 6 0 0 1 10 4m0 2a4 4 0 1 0 0 8a4 4 0 0 0 0-8Z"/>
        </svg>
        <input id="q" class="searchInput" type="search" placeholder="S√∂k i ingredienser‚Ä¶" autocomplete="off" />
        <span class="kbd" title="Snabbtangent">/</span>
      </div>

      <div class="chipsRow" aria-label="Snabbinfo" style="margin-top:12px;">
        <span class="badge badgeMuted" id="pillStatus">‚Äî</span>
        <span class="badge badgeMuted" id="pillSubs">‚Äî</span>
        <span class="badge badgeMuted" id="pillSize">‚Äî</span>
      </div>
    </section>

    <!-- Sticky actions (under hero) -->
    <div class="card mt16" style="padding:12px 14px; position:sticky; top:64px; z-index:10;">
      <div class="flexBetween">
        <div class="flex gap10" style="align-items:center; flex-wrap:wrap;">
          <span class="badge badgeMuted">MVP</span>
          <span class="muted small">√Ñndringar sparas som demo i minne (session).</span>
        </div>

        <div class="flex gap10" style="align-items:center; flex-wrap:wrap;">
          <div class="chip">
            <label for="portionSel">Portioner</label>
            <select id="portionSel">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>

          <div class="chip">
            <label for="sizeSel">Portionsstorlek</label>
            <select id="sizeSel">
              <option value="350 g">350 g</option>
              <option value="400 g">400 g</option>
              <option value="440 g">440 g</option>
              <option value="500 g" selected>500 g</option>
              <option value="550 g">550 g</option>
            </select>
          </div>

          <div class="chip">
            <label for="readySel">Beredd</label>
            <select id="readySel">
              <option value="no" selected>Nej</option>
              <option value="yes">Ja</option>
            </select>
          </div>
        </div>
      </div>

      <p class="muted small" id="saveNote" style="margin:10px 0 0 0;"></p>
    </div>

    <div class="grid grid2 mt16">

      <!-- LEFT: Underrecept + Ingredienser -->
      <section class="card" style="padding:18px;">
        <div class="flexBetween">
          <div>
            <h2 style="margin:0; font-size:16px; font-weight:900;">Underrecept & ingredienser</h2>
            <div class="muted small">Klicka underrecept f√∂r att hoppa till r√§tt tillagning. S√∂k filtrerar tabellen.</div>
          </div>
          <button class="btn" id="addRow">+ L√§gg till</button>
        </div>

        <hr class="hr" />

        <div class="card" style="padding:14px; box-shadow:none;">
          <div class="flexBetween" style="align-items:flex-start; gap:10px;">
            <div>
              <div style="font-weight:900;">Underrecept</div>
              <div class="muted small" id="subsHint" style="margin-top:6px;">‚Äî</div>
            </div>
            <button class="btn" id="goCooking" type="button" title="Visa tillagning">Visa tillagning</button>
          </div>

          <ul id="subsList" style="margin:10px 0 0 0; padding:0; list-style:none;"></ul>
        </div>

        <div class="card mt16 tableCard" style="box-shadow:none;">
          <table class="table" aria-label="Ingredienser">
            <thead>
              <tr>
                <th style="width:34%;">Ingrediens</th>
                <th style="width:14%;">M√§ngd</th>
                <th style="width:12%;">Enhet</th>
                <th style="width:16%;">B√§st f√∂re</th>
                <th style="width:18%;">K√§lla</th>
                <th class="actions" style="width:6%;">‚Äî</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="muted small mt12">
          Tips: skriv <span class="kbd">/</span> f√∂r att s√∂ka i listan.
        </div>
      </section>

      <!-- RIGHT: Tillagning per delrecept -->
      <aside class="card" style="padding:18px;">
        <div class="flexBetween" style="align-items:flex-start; gap:12px;">
          <div>
            <h2 style="margin:0; font-size:16px; font-weight:900;">Tillagning</h2>
            <p class="muted small" style="margin-top:6px;">Uppdelat per delrecept f√∂r att bli tydligt i produktion.</p>
          </div>
          <span class="badge badgeMuted" id="cookBadge">‚Äî</span>
        </div>

        <div class="tabs mt12" role="tablist" aria-label="Tillagningsflikar" id="cookTabs"></div>

        <div class="card mt12" style="padding:14px; box-shadow:none;">
          <div class="muted small" id="cookHint">‚Äî</div>

          <div class="field mt12">
            <label for="cookTitle">Rubrik</label>
            <input class="input" id="cookTitle" type="text" />
          </div>

          <div class="field">
            <label for="cookDesc">Beskrivning</label>
            <textarea class="input" id="cookDesc" rows="3" style="resize:vertical;"></textarea>
          </div>

          <div class="field">
            <label for="cookSteps">Instruktioner (steg)</label>
            <textarea class="input" id="cookSteps" rows="9" style="resize:vertical;" placeholder="1. ‚Ä¶&#10;2. ‚Ä¶"></textarea>
          </div>

          <div class="field">
            <label for="cookNote">Notering</label>
            <textarea class="input" id="cookNote" rows="3" style="resize:vertical;" placeholder="Intern notering‚Ä¶"></textarea>
          </div>

          <button class="btn btnPrimary w100" id="saveCooking" type="button">Spara tillagning (demo)</button>
          <p class="muted small mt12" id="cookSaveNote"></p>

          <hr class="hr" />

          <div style="font-weight:900;">F√∂rhandsvisning</div>
          <ol class="muted small" id="cookPreview" style="margin:8px 0 0 18px;"></ol>
        </div>
      </aside>

    </div>

  </main>

  <!-- OVERLAY + DRAWER: Klimat & n√§ring -->
  <div class="overlay" id="overlay" aria-hidden="true"></div>
  <aside class="drawer" id="drawer" aria-label="Klimat & n√§ring">
    <div class="drawerHeader">
      <div>
        <div class="drawerTitle">Klimat & n√§ring</div>
        <div class="muted small" id="dSub">‚Äî</div>
      </div>
      <button class="iconBtn" id="dClose" title="St√§ng" aria-label="St√§ng">‚úï</button>
    </div>

    <div class="drawerBody">
      <div class="tabs" role="tablist" aria-label="Flikar">
        <button class="tab active" data-tab="climate" type="button">Klimat</button>
        <button class="tab" data-tab="energy" type="button">Energi</button>
        <button class="tab" data-tab="history" type="button">Historik</button>
      </div>

      <div id="tab_climate">
        <div class="card" style="padding:14px; box-shadow:none;">
          <div class="flexBetween">
            <div>
              <div style="font-weight:900;">CO‚ÇÇe totalt</div>
              <div class="muted small">Ber√§knad (demo)</div>
            </div>
            <span class="badge badgeMuted" id="co2Total">‚Äî</span>
          </div>
          <hr class="hr" />
          <div class="flexBetween">
            <div>
              <div style="font-weight:900;">CO‚ÇÇe per portion</div>
              <div class="muted small">Baserat p√• portioner</div>
            </div>
            <span class="badge badgeMuted" id="co2Per">‚Äî</span>
          </div>
        </div>
      </div>

      <div id="tab_energy" style="display:none;">
        <div class="card" style="padding:14px; box-shadow:none;">
          <div class="flexBetween">
            <div>
              <div style="font-weight:900;">Energidistribution</div>
              <div class="muted small">Fett / Kolhydrater / Protein</div>
            </div>
            <span class="badge badgeMuted" id="energyDist">‚Äî</span>
          </div>
          <hr class="hr" />
          <div class="flexBetween">
            <div>
              <div style="font-weight:900;">M√•ltidsstorlek</div>
              <div class="muted small">Portionsvikt</div>
            </div>
            <span class="badge badgeMuted" id="mealSize">‚Äî</span>
          </div>
        </div>
      </div>

      <div id="tab_history" style="display:none;">
        <p class="muted small">Visar datum + vad som √§ndrades (demo).</p>
        <div class="card" style="padding:14px; box-shadow:none;" id="histBox"></div>
      </div>

    </div>
  </aside>

  <script type="module">
    import { getMockDB, expandMeal } from '../assets/js/app.js';

    const $ = (sel) => document.querySelector(sel);

    // Help popover (stabil toggle)
    const helpBtn = $('#helpBtn');
    const helpPop = $('#helpPop');
    const helpClose = $('#helpClose');
    let helpOpen = false;

    function openHelp(){
      helpOpen = true;
      helpPop.style.display = '';
      helpBtn.setAttribute('aria-expanded', 'true');
      setTimeout(() => {
        const onDoc = (e) => {
          if (!helpPop.contains(e.target) && e.target !== helpBtn){
            document.removeEventListener('mousedown', onDoc);
            closeHelp();
          }
        };
        document.addEventListener('mousedown', onDoc);
      }, 0);
    }
    function closeHelp(){
      helpOpen = false;
      helpPop.style.display = 'none';
      helpBtn.setAttribute('aria-expanded', 'false');
    }
    helpBtn.addEventListener('click', () => {
      if (helpOpen) closeHelp(); else openHelp();
    });
    helpClose.addEventListener('click', closeHelp);

    // Drawer tabs
    const tabs = Array.from(document.querySelectorAll('.drawer .tab'));
    const tabViews = {
      climate: $('#tab_climate'),
      energy: $('#tab_energy'),
      history: $('#tab_history')
    };
    function setTab(key){
      for (const [k, el] of Object.entries(tabViews)){
        el.style.display = (k === key) ? '' : 'none';
      }
      tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === key));
    }

    // Elements
    const elBack = $('#backBtn');
    const elQ = $('#q');
    const elTbody = $('#tbody');

    const elOverlay = $('#overlay');
    const elDrawer = $('#drawer');
    const elDClose = $('#dClose');
    const elClimateBtn = $('#climateBtn');

    const elH1 = $('#h1');
    const elHSub = $('#hSub');
    const elSubtitle = $('#subtitle');

    const pillStatus = $('#pillStatus');
    const pillSubs = $('#pillSubs');
    const pillSize = $('#pillSize');

    const subsHint = $('#subsHint');
    const subsList = $('#subsList');

    const portionSel = $('#portionSel');
    const sizeSel = $('#sizeSel');
    const saveBtn = $('#saveBtn');
    const saveNote = $('#saveNote');

    // Cooking UI
    const cookTabs = $('#cookTabs');
    const cookBadge = $('#cookBadge');
    const cookHint = $('#cookHint');
    const cookTitle = $('#cookTitle');
    const cookDesc = $('#cookDesc');
    const cookSteps = $('#cookSteps');
    const cookNote = $('#cookNote');
    const cookPreview = $('#cookPreview');
    const saveCooking = $('#saveCooking');
    const cookSaveNote = $('#cookSaveNote');
    const goCooking = $('#goCooking');

    // Load from ?id=
    const db = getMockDB();
    const params = new URLSearchParams(location.search);
    const id = params.get('id') || db.meals[0]; // fallback f√∂rsta m√•ltiden

    const { meal } = expandMeal(db, id);

    // Fail-closed-ish: om id inte √§r m√•ltid
    const activeMeal = (meal && meal.type === 'meal') ? meal : db.byId.get(db.meals[0]);
    const expanded = expandMeal(db, activeMeal.id);

    // State
    const state = {
      meal: expanded.meal,
      subs: expanded.subs,
      q: '',
      rows: [],
      portions: parseInt(portionSel.value, 10) || 25,
      size: sizeSel.value,

      // Tillagning per flik: key = "meal" eller sub.id
      cook: {
        activeKey: 'meal',
        byKey: {} // { [key]: { title, desc, steps, note } }
      }
    };

    // Helpers
    function uid(prefix){
      return prefix + '_' + Math.random().toString(16).slice(2);
    }
    function safeStr(v){
      return (v === null || v === undefined) ? '' : String(v);
    }
    function normalizeSteps(text){
      const raw = safeStr(text).trim();
      if (!raw) return [];
      // split p√• radbrytningar, ta bort tomrader
      return raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    }

    function initCook(){
      // √ñversikt (meal)
      state.cook.byKey['meal'] = {
        title: state.meal.name,
        desc: state.meal.desc || '',
        steps: '1. F√∂rbered ingredienser.\n2. Tillaga underrecept.\n3. Montera m√•ltiden.\n4. Servera.',
        note: ''
      };

      // Ett block per underrecept
      for (const s of state.subs){
        state.cook.byKey[s.id] = {
          title: s.name,
          desc: s.desc || '',
          steps: '1. F√∂rbered.\n2. Tillaga.\n3. Klart.',
          note: ''
        };
      }
    }

    function buildRows(){
      const out = [];

      // Meal-level ingredienser (k√§lla = M√•ltid)
      const mIng = Array.isArray(state.meal.ingredients) ? state.meal.ingredients : [];
      for (const it of mIng){
        out.push({
          id: uid('m'),
          name: safeStr(it.name),
          qty: safeStr(it.qty ?? ''),
          unit: safeStr(it.unit ?? 'g'),
          bestBefore: '',       // NYTT
          source: 'M√•ltid'
        });
      }

      // Underrecept ingredienser (k√§lla = underrecept namn)
      for (const s of state.subs){
        const sIng = Array.isArray(s.ingredients) ? s.ingredients : [];
        for (const it of sIng){
          out.push({
            id: uid('s'),
            name: safeStr(it.name),
            qty: safeStr(it.qty ?? ''),
            unit: safeStr(it.unit ?? 'g'),
            bestBefore: '',       // NYTT
            source: s.name
          });
        }
      }

      state.rows = out;
    }

    function renderHeader(){
      elH1.textContent = state.meal.name;
      elHSub.textContent = state.meal.desc ? state.meal.desc : 'Arbetsyta f√∂r m√•ltiden.';
      elSubtitle.textContent = state.meal.name;

      pillStatus.textContent = state.meal.status === 'active' ? 'Aktiv' : 'Inaktiv';
      pillStatus.className = 'badge ' + (state.meal.status === 'active' ? 'badgeOk' : 'badgeMuted');

      pillSubs.textContent = `${state.subs.length} underrecept`;
      pillSize.textContent = state.meal.size || state.size || '‚Äî';

      subsHint.textContent = state.subs.length ? 'Ing√•r i m√•ltiden:' : 'Inga underrecept kopplade.';
      subsList.textContent = '';

      for (const s of state.subs){
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.justifyContent = 'space-between';
        li.style.gap = '10px';
        li.style.padding = '10px 10px';
        li.style.border = '1px solid var(--border)';
        li.style.borderRadius = '12px';
        li.style.marginTop = '8px';
        li.style.cursor = 'pointer';

        const left = document.createElement('div');
        const title = document.createElement('div');
        title.style.fontWeight = '900';
        title.textContent = s.name;

        const meta = document.createElement('div');
        meta.className = 'muted small';
        meta.textContent = (s.status === 'inactive') ? 'Inaktiv' : 'Aktiv';

        left.appendChild(title);
        left.appendChild(meta);

        const right = document.createElement('div');
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.type = 'button';
        btn.textContent = 'Tillagning';
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          setCookTab(s.id);
        });

        right.appendChild(btn);

        li.appendChild(left);
        li.appendChild(right);

        li.addEventListener('click', () => setCookTab(s.id));
        subsList.appendChild(li);
      }
    }

    function matchesRow(r){
      const q = state.q.trim().toLowerCase();
      if (!q) return true;
      return (`${r.name} ${r.source} ${r.unit}`).toLowerCase().includes(q);
    }

    function renderTable(){
      elTbody.textContent = '';

      const rows = state.rows.filter(matchesRow);
      for (const r of rows){
        const tr = document.createElement('tr');

        const tdName = document.createElement('td');
        tdName.textContent = r.name;

        const tdQty = document.createElement('td');
        const qty = document.createElement('input');
        qty.className = 'input';
        qty.value = r.qty;
        qty.addEventListener('input', () => r.qty = qty.value);
        tdQty.appendChild(qty);

        const tdUnit = document.createElement('td');
        const unit = document.createElement('select');
        ['g','kg','l','dl','st'].forEach(u => {
          const o = document.createElement('option');
          o.value = u;
          o.textContent = u;
          if (r.unit === u) o.selected = true;
          unit.appendChild(o);
        });
        unit.addEventListener('change', () => r.unit = unit.value);
        tdUnit.appendChild(unit);

        // NYTT: B√§st f√∂re
        const tdBB = document.createElement('td');
        const bb = document.createElement('input');
        bb.className = 'input';
        bb.type = 'date';
        bb.value = r.bestBefore;
        bb.addEventListener('change', () => r.bestBefore = bb.value);
        tdBB.appendChild(bb);

        const tdSrc = document.createElement('td');
        tdSrc.textContent = r.source;

        const tdAct = document.createElement('td');
        tdAct.className = 'actions';
        const del = document.createElement('button');
        del.className = 'iconBtn';
        del.title = 'Ta bort';
        del.textContent = 'üóë';
        del.addEventListener('click', () => {
          state.rows = state.rows.filter(x => x !== r);
          renderTable();
        });
        tdAct.appendChild(del);

        tr.appendChild(tdName);
        tr.appendChild(tdQty);
        tr.appendChild(tdUnit);
        tr.appendChild(tdBB);
        tr.appendChild(tdSrc);
        tr.appendChild(tdAct);

        elTbody.appendChild(tr);
      }
    }

    // Drawer open/close
    function openDrawer(){
      refreshDrawer();
      elOverlay.classList.add('open');
      elDrawer.classList.add('open');
      elOverlay.setAttribute('aria-hidden', 'false');
    }
    function closeDrawer(){
      elOverlay.classList.remove('open');
      elDrawer.classList.remove('open');
      elOverlay.setAttribute('aria-hidden', 'true');
    }

    function refreshDrawer(){
      const p = state.portions || 1;
      $('#co2Total').textContent = '‚Äî';
      $('#co2Per').textContent = '‚Äî';
      $('#energyDist').textContent = '‚Äî';
      $('#mealSize').textContent = state.size;
      $('#dSub').textContent = `${p} portioner ‚Ä¢ ${state.size}`;

      const hist = $('#histBox');
      hist.textContent = '';
      const arr = Array.isArray(state.meal.history) ? state.meal.history : [];
      if (arr.length === 0){
        hist.textContent = '‚Äî';
        return;
      }
      for (const h of arr){
        const div = document.createElement('div');
        div.style.padding = '10px 0';
        div.style.borderBottom = '1px solid var(--border)';
        div.textContent = `${h.date} ‚Ä¢ ${h.change}`;
        hist.appendChild(div);
      }
    }

    // Cooking tabs
    function renderCookTabs(){
      cookTabs.textContent = '';

      const mkBtn = (key, label) => {
        const b = document.createElement('button');
        b.className = 'tab' + (state.cook.activeKey === key ? ' active' : '');
        b.type = 'button';
        b.dataset.key = key;
        b.textContent = label;
        b.addEventListener('click', () => setCookTab(key));
        return b;
      };

      cookTabs.appendChild(mkBtn('meal', '√ñversikt'));

      for (const s of state.subs){
        cookTabs.appendChild(mkBtn(s.id, s.name));
      }

      const activeLabel = (state.cook.activeKey === 'meal')
        ? '√ñversikt'
        : (state.subs.find(x => x.id === state.cook.activeKey)?.name || 'Delrecept');

      cookBadge.textContent = activeLabel;
    }

    function renderCookEditor(){
      const key = state.cook.activeKey;
      const data = state.cook.byKey[key] || { title:'', desc:'', steps:'', note:'' };

      cookTitle.value = data.title;
      cookDesc.value = data.desc;
      cookSteps.value = data.steps;
      cookNote.value = data.note;

      const hint = (key === 'meal')
        ? '√ñversikt f√∂r hela m√•ltiden. H√§r kan du skriva hur allt monteras och serveras.'
        : 'Tillagning f√∂r valt underrecept. H√•ll det kort och stegvis.';

      cookHint.textContent = hint;

      // Preview
      cookPreview.textContent = '';
      const items = normalizeSteps(data.steps);
      if (items.length === 0){
        const li = document.createElement('li');
        li.textContent = '‚Äî';
        cookPreview.appendChild(li);
      } else {
        items.forEach(line => {
          const li = document.createElement('li');
          li.textContent = line;
          cookPreview.appendChild(li);
        });
      }
    }

    function setCookTab(key){
      if (!state.cook.byKey[key]) return;
      state.cook.activeKey = key;
      renderCookTabs();
      renderCookEditor();
      // scrolla till tillagning (h√∂gerpanelen)
      // (mjuk scroll utan att bero p√• CSS)
      try {
        cookTabs.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch {}
    }

    function saveCookActive(){
      const key = state.cook.activeKey;
      if (!state.cook.byKey[key]) return;

      state.cook.byKey[key] = {
        title: cookTitle.value.trim() || state.cook.byKey[key].title,
        desc: cookDesc.value,
        steps: cookSteps.value,
        note: cookNote.value
      };

      cookSaveNote.textContent = 'Sparat (demo).';
      setTimeout(() => { cookSaveNote.textContent = ''; }, 2000);
      renderCookEditor();
    }

    // Events
    elBack.addEventListener('click', () => history.back());

    window.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== elQ){
        e.preventDefault();
        elQ.focus();
      }
      if (e.key === 'Escape'){
        closeDrawer();
        closeHelp();
      }
    });

    elQ.addEventListener('input', () => {
      state.q = elQ.value;
      renderTable();
    });

    $('#addRow').addEventListener('click', () => {
      state.rows.unshift({
        id: uid('x'),
        name: 'Ny ingrediens',
        qty: '1',
        unit: 'st',
        bestBefore: '',
        source: 'M√•ltid'
      });
      renderTable();
    });

    portionSel.addEventListener('change', () => {
      state.portions = parseInt(portionSel.value, 10) || 1;
      refreshDrawer();
    });

    sizeSel.addEventListener('change', () => {
      state.size = sizeSel.value;
      pillSize.textContent = state.size;
      refreshDrawer();
    });

    elClimateBtn.addEventListener('click', () => {
      openDrawer();
      setTab('climate');
    });

    elOverlay.addEventListener('click', closeDrawer);
    elDClose.addEventListener('click', closeDrawer);
    tabs.forEach(t => t.addEventListener('click', () => setTab(t.dataset.tab)));

    goCooking.addEventListener('click', () => setCookTab('meal'));
    saveCooking.addEventListener('click', saveCookActive);

    saveBtn.addEventListener('click', () => {
      saveNote.textContent = 'Sparat (demo).';
      setTimeout(() => { saveNote.textContent = ''; }, 2200);
    });

    // Boot
    initCook();
    buildRows();
    renderHeader();
    renderTable();
    renderCookTabs();
    renderCookEditor();
    setTab('climate');
  </script>

</body>
</html>
