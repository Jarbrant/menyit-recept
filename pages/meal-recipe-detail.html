<!-- ============================================================
     FIL: pages/meal-recipe-detail.html  (HEL FIL)
     Sida 4: M√•ltidsrecept detalj / arbetsyta
     UI: sticky actions + ingredienslista + sidopanel f√∂r klimat/n√§ring + instruktioner
     Policy: statisk GitHub Pages, inga externa libs, XSS-safe (textContent)
============================================================ -->
<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kostdata ‚Äî M√•ltidsrecept detalj</title>
  <link rel="stylesheet" href="../assets/css/main.css" />
</head>
<body>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <button class="backBtn" id="backBtn" title="Tillbaka" aria-label="Tillbaka">‚Üê</button>
        <div>
          <div class="pageTitle">M√•ltidsrecept</div>
          <div class="muted small" id="subtitle">Detaljvy</div>
        </div>
      </div>

      <div class="centerSlot">
        <div class="searchWrap" style="max-width:780px; width:100%;">
          <svg class="searchIcon" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M10 4a6 6 0 1 1 3.87 10.58l4.28 4.28-1.42 1.42-4.28-4.28A6 6 0 0 1 10 4m0 2a4 4 0 1 0 0 8a4 4 0 0 0 0-8Z"/>
          </svg>
          <input id="q" class="searchInput" type="search" placeholder="S√∂k i ingredienser‚Ä¶" autocomplete="off" />
          <span class="kbd" title="Snabbtangent">/</span>
        </div>
      </div>

      <div class="rightSlot">
        <a class="btn" href="./recipes.html" title="Receptlista">Recept</a>
        <button class="btn" id="climateBtn">Klimat & n√§ring</button>
        <button class="btn btnPrimary" id="saveBtn">Spara</button>
      </div>
    </div>
  </header>

  <!-- Sticky actions (under topbar) -->
  <div class="container" style="padding-top:12px;">
    <div class="card" style="padding:12px 14px; position:sticky; top:64px; z-index:10;">
      <div class="flexBetween">
        <div class="flex gap10" style="align-items:center; flex-wrap:wrap;">
          <span class="badge badgeMuted">MVP</span>
          <span class="muted small">√Ñndringar sparas som demo i minne.</span>
        </div>

        <div class="flex gap10" style="align-items:center; flex-wrap:wrap;">
          <div class="chip">
            <label for="portionSel">Portioner</label>
            <select id="portionSel">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>

          <div class="chip">
            <label for="sizeSel">Portionsstorlek</label>
            <select id="sizeSel">
              <option value="350g">350 g</option>
              <option value="400g">400 g</option>
              <option value="450g">450 g</option>
              <option value="500g" selected>500 g</option>
              <option value="550g">550 g</option>
            </select>
          </div>

          <div class="chip">
            <label for="readySel">Beredd</label>
            <select id="readySel">
              <option value="no" selected>Nej</option>
              <option value="yes">Ja</option>
            </select>
          </div>
        </div>
      </div>

      <p class="muted small" id="saveNote" style="margin:10px 0 0 0;"></p>
    </div>
  </div>

  <main class="container">

    <div class="grid grid2">

      <!-- LEFT: Ingredienser -->
      <section class="card" style="padding:18px;">
        <div class="flexBetween">
          <div>
            <h2 style="margin:0; font-size:16px; font-weight:900;">Ingredienser</h2>
            <div class="muted small">Justera m√§ngd och enhet. Klicka p√• en rad f√∂r mer info.</div>
          </div>
          <button class="btn" id="addRow">+ L√§gg till</button>
        </div>

        <hr class="hr" />

        <div class="card tableCard" style="box-shadow:none;">
          <table class="table" aria-label="Ingredienser">
            <thead>
              <tr>
                <th style="width:44%;">Ingrediens</th>
                <th style="width:18%;">M√§ngd</th>
                <th style="width:18%;">Enhet</th>
                <th style="width:14%;">Pris</th>
                <th class="actions" style="width:6%;">‚Äî</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="muted small mt12">
          Tips: skriv <span class="kbd">/</span> f√∂r att s√∂ka i listan.
        </div>
      </section>

      <!-- RIGHT: Instruktioner + notering -->
      <aside class="card" style="padding:18px;">
        <h2 style="margin:0; font-size:16px; font-weight:900;">G√∂r s√• h√§r</h2>
        <p class="muted small" style="margin-top:6px;">Instruktioner ligger h√§r f√∂r arbetsro. Klimat/n√§ring √∂ppnas i eget f√∂nster.</p>

        <div class="field mt16">
          <label for="title">Rubrik</label>
          <input class="input" id="title" type="text" />
        </div>

        <div class="field">
          <label for="desc">Beskrivning</label>
          <textarea class="input" id="desc" rows="4" style="resize:vertical;"></textarea>
        </div>

        <div class="field">
          <label for="steps">Instruktioner</label>
          <textarea class="input" id="steps" rows="10" style="resize:vertical;"></textarea>
        </div>

        <div class="field">
          <label for="note">Notering</label>
          <textarea class="input" id="note" rows="4" style="resize:vertical;" placeholder="Intern notering‚Ä¶"></textarea>
        </div>

        <button class="btn btnPrimary w100" id="saveText">Spara text (demo)</button>
        <p class="muted small mt12" id="textNote"></p>
      </aside>

    </div>

  </main>

  <!-- OVERLAY + DRAWER: Klimat & n√§ring -->
  <div class="overlay" id="overlay" aria-hidden="true"></div>
  <aside class="drawer" id="drawer" aria-label="Klimat & n√§ring">
    <div class="drawerHeader">
      <div>
        <div class="drawerTitle">Klimat & n√§ring</div>
        <div class="muted small" id="dSub">‚Äî</div>
      </div>
      <button class="iconBtn" id="dClose" title="St√§ng" aria-label="St√§ng">‚úï</button>
    </div>

    <div class="drawerBody">
      <div class="tabs" role="tablist" aria-label="Flikar">
        <button class="tab active" data-tab="climate" type="button">Klimat</button>
        <button class="tab" data-tab="energy" type="button">Energi</button>
        <button class="tab" data-tab="history" type="button">Historik</button>
      </div>

      <div id="tab_climate">
        <div class="card" style="padding:14px; box-shadow:none;">
          <div class="flexBetween">
            <div>
              <div style="font-weight:900;">CO‚ÇÇe totalt</div>
              <div class="muted small">Ber√§knad (demo)</div>
            </div>
            <span class="badge badgeMuted" id="co2Total">‚Äî</span>
          </div>
          <hr class="hr" />
          <div class="flexBetween">
            <div>
              <div style="font-weight:900;">CO‚ÇÇe per portion</div>
              <div class="muted small">Baserat p√• portioner</div>
            </div>
            <span class="badge badgeMuted" id="co2Per">‚Äî</span>
          </div>
        </div>
      </div>

      <div id="tab_energy" style="display:none;">
        <div class="card" style="padding:14px; box-shadow:none;">
          <div class="flexBetween">
            <div>
              <div style="font-weight:900;">Energidistribution</div>
              <div class="muted small">Fett / Kolhydrater / Protein</div>
            </div>
            <span class="badge badgeMuted" id="energyDist">‚Äî</span>
          </div>
          <hr class="hr" />
          <div class="flexBetween">
            <div>
              <div style="font-weight:900;">M√•ltidsstorlek</div>
              <div class="muted small">Portionsvikt</div>
            </div>
            <span class="badge badgeMuted" id="mealSize">‚Äî</span>
          </div>
        </div>
      </div>

      <div id="tab_history" style="display:none;">
        <p class="muted small">H√§r kan ni senare visa exakt datum n√§r leverant√∂ren uppdaterade en produkt + vad som √§ndrades.</p>
        <div class="card" style="padding:14px; box-shadow:none;" id="histBox"></div>
      </div>

    </div>
  </aside>

  <script type="module">
    const $ = (sel) => document.querySelector(sel);

    const elBack = $('#backBtn');
    const elQ = $('#q');

    const elTbody = $('#tbody');
    const elSaveBtn = $('#saveBtn');
    const elSaveNote = $('#saveNote');

    const elOverlay = $('#overlay');
    const elDrawer = $('#drawer');
    const elDSub = $('#dSub');
    const elDClose = $('#dClose');
    const elClimateBtn = $('#climateBtn');

    const elPortions = $('#portionSel');
    const elSize = $('#sizeSel');

    const tabs = Array.from(document.querySelectorAll('.tab'));
    const tabViews = {
      climate: $('#tab_climate'),
      energy: $('#tab_energy'),
      history: $('#tab_history'),
    };

    // Demo state
    const state = {
      title: 'Fiskpanetter med kokt potatis och remoulads√•s',
      desc: '',
      steps: '1. F√∂rbered ingredienser.\n2. Tillaga enligt rutin.\n3. Smaka av.\n4. Servera.',
      note: '',
      portions: 25,
      size: '500g',
      items: [
        { id:'a1', name:'Fiskpanetter', qty:'2.5', unit:'kg', price:'‚Äî' },
        { id:'a2', name:'Potatis', qty:'7.0', unit:'kg', price:'‚Äî' },
        { id:'a3', name:'Remoulads√•s', qty:'1.2', unit:'kg', price:'‚Äî' },
        { id:'a4', name:'Citron', qty:'0.2', unit:'kg', price:'‚Äî' }
      ],
      q: ''
    };

    function text(v){ return (v ?? '').toString(); }

    function renderText(){
      $('#title').value = state.title;
      $('#desc').value = state.desc;
      $('#steps').value = state.steps;
      $('#note').value = state.note;
      $('#subtitle').textContent = state.title;
    }

    function matchesItem(it){
      const q = state.q.trim().toLowerCase();
      if (!q) return true;
      return `${it.name} ${it.unit}`.toLowerCase().includes(q);
    }

    function renderTable(){
      elTbody.textContent = '';
      for (const it of state.items.filter(matchesItem)){
        const tr = document.createElement('tr');

        const tdName = document.createElement('td');
        tdName.textContent = it.name;

        const tdQty = document.createElement('td');
        const qty = document.createElement('input');
        qty.className = 'input';
        qty.value = it.qty;
        qty.addEventListener('input', () => { it.qty = qty.value; });
        tdQty.appendChild(qty);

        const tdUnit = document.createElement('td');
        const unit = document.createElement('select');
        unit.innerHTML = '';
        ['g','kg','l','dl','st'].forEach(u => {
          const o = document.createElement('option');
          o.value = u;
          o.textContent = u;
          if (it.unit === u) o.selected = true;
          unit.appendChild(o);
        });
        unit.addEventListener('change', () => { it.unit = unit.value; });
        tdUnit.appendChild(unit);

        const tdPrice = document.createElement('td');
        tdPrice.textContent = it.price;

        const tdAct = document.createElement('td');
        tdAct.className = 'actions';
        const del = document.createElement('button');
        del.className = 'iconBtn';
        del.title = 'Ta bort';
        del.textContent = 'üóë';
        del.addEventListener('click', () => {
          state.items = state.items.filter(x => x.id !== it.id);
          renderTable();
        });
        tdAct.appendChild(del);

        tr.appendChild(tdName);
        tr.appendChild(tdQty);
        tr.appendChild(tdUnit);
        tr.appendChild(tdPrice);
        tr.appendChild(tdAct);

        elTbody.appendChild(tr);
      }
    }

    function openDrawer(){
      refreshDrawer();
      elOverlay.classList.add('open');
      elDrawer.classList.add('open');
      elOverlay.setAttribute('aria-hidden', 'false');
    }

    function closeDrawer(){
      elOverlay.classList.remove('open');
      elDrawer.classList.remove('open');
      elOverlay.setAttribute('aria-hidden', 'true');
    }

    function setTab(key){
      for (const [k, el] of Object.entries(tabViews)){
        el.style.display = (k === key) ? '' : 'none';
      }
      tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === key));
    }

    function refreshDrawer(){
      const p = state.portions || 1;

      // Demo-ber√§kning (placeholder)
      const co2Total = '‚Äî';
      const co2Per = '‚Äî';
      $('#co2Total').textContent = co2Total;
      $('#co2Per').textContent = co2Per;

      $('#energyDist').textContent = '‚Äî';
      $('#mealSize').textContent = state.size;

      elDSub.textContent = `${p} portioner ‚Ä¢ ${state.size}`;

      // Historik placeholder
      const hist = $('#histBox');
      hist.textContent = '';
      const lines = [
        '2026-02-20 ‚Ä¢ Leverant√∂r: √§ndrade pris (exempel)',
        '2026-02-12 ‚Ä¢ Produkt: uppdaterad f√∂rpackning (exempel)',
        '2026-02-01 ‚Ä¢ Ny produkt uppt√§ckt vid nattk√∂rning (exempel)'
      ];
      for (const line of lines){
        const div = document.createElement('div');
        div.style.padding = '10px 0';
        div.style.borderBottom = '1px solid var(--border)';
        div.textContent = line;
        hist.appendChild(div);
      }
    }

    // Events
    elBack.addEventListener('click', () => history.back());

    window.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== elQ){
        e.preventDefault();
        elQ.focus();
      }
      if (e.key === 'Escape'){
        closeDrawer();
      }
    });

    elQ.addEventListener('input', () => {
      state.q = elQ.value;
      renderTable();
    });

    $('#addRow').addEventListener('click', () => {
      const id = 'x' + Math.random().toString(16).slice(2);
      state.items.unshift({ id, name:'Ny ingrediens', qty:'1', unit:'st', price:'‚Äî' });
      renderTable();
    });

    elPortions.addEventListener('change', () => {
      state.portions = parseInt(elPortions.value, 10) || 1;
      refreshDrawer();
    });

    elSize.addEventListener('change', () => {
      state.size = elSize.value;
      refreshDrawer();
    });

    elClimateBtn.addEventListener('click', () => {
      openDrawer();
      setTab('climate');
    });

    elOverlay.addEventListener('click', closeDrawer);
    elDClose.addEventListener('click', closeDrawer);

    tabs.forEach(t => t.addEventListener('click', () => setTab(t.dataset.tab)));

    $('#saveText').addEventListener('click', () => {
      state.title = $('#title').value.trim() || state.title;
      state.desc = $('#desc').value;
      state.steps = $('#steps').value;
      state.note = $('#note').value;
      $('#textNote').textContent = 'Sparat (demo).';
      renderText();
    });

    elSaveBtn.addEventListener('click', () => {
      elSaveNote.textContent = 'Sparat (demo).';
      setTimeout(() => { elSaveNote.textContent = ''; }, 2200);
    });

    // Boot
    renderText();
    renderTable();
    setTab('climate');
  </script>

</body>
</html>
