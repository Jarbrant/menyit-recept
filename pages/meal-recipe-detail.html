<!-- ============================================================
     FIL: pages/meal-recipe-detail.html  (HEL FIL)
     Sida: M√•ltidsrecept detalj (SUPERSIDA v1)

     PATCH: AO-RECIPES-SUPERPAGE-01 (FAS 1)
     M√•l:
       - Supersnygg detaljsida som anv√§nder full fejkmodell (assets/js/app.js)
       - Endast underrecept fr√•n meal.subRecipeIds visas (ingen ‚Äúextra‚Äù sektion om tom)
       - Portioner skalar ingrediensm√§ngder (demo-skalning bas=25 portioner)
       - Tillagning per delrecept + √ñversikt (l√§ser fr√•n meal.instructions / sub.instructions)
       - Drawer visar CO‚ÇÇ + N√§ring + Historik (l√§ser fr√•n meal.co2 / meal.nutrition / meal.history / meal.supplierUpdatedAt)
       - Produktkort-mini (popover) n√§r man klickar p√• ingrediensnamn (displayName/brandLine/comparePrice/offerLabel/co2PerKgLabel)
     Policy: statisk GitHub Pages, inga externa libs, XSS-safe (textContent)
============================================================ -->
<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kostdata ‚Äî M√•ltidsrecept detalj</title>
  <link rel="stylesheet" href="../assets/css/main.css" />
</head>
<body>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <button class="backBtn" id="backBtn" title="Tillbaka" aria-label="Tillbaka">‚Üê</button>
        <div>
          <div class="pageTitle">M√•ltidsrecept</div>
          <div id="subtitle" class="muted" style="font-size:15px; font-weight:800; line-height:1.2; margin-top:2px;">‚Äî</div>
        </div>
      </div>

      <div class="centerSlot"></div>

      <div class="rightSlot" style="position:relative;">
        <button class="btn" id="helpBtn" type="button" aria-haspopup="dialog" aria-expanded="false">Hj√§lp</button>
        <a class="btn" href="./recipes.html" title="Receptlista">Recept</a>
        <button class="btn" id="climateBtn" type="button">Klimat & n√§ring</button>
        <button class="btn btnPrimary" id="saveBtn" type="button">Spara</button>

        <!-- Hj√§lpruta (popover) -->
        <div id="helpPop"
             class="card"
             role="dialog"
             aria-label="Hj√§lp"
             style="
               display:none;
               position:absolute;
               right:0;
               top:48px;
               width:min(420px, 92vw);
               padding:14px;
               box-shadow: var(--shadow2);
               z-index: 60;">
          <div class="flexBetween">
            <div style="font-weight:900;">Snabbhj√§lp</div>
            <button class="iconBtn" id="helpClose" type="button" aria-label="St√§ng hj√§lp">‚úï</button>
          </div>

          <div class="muted small mt12">
            <div><span class="kbd">/</span> fokuserar s√∂k</div>
            <div><span class="kbd">Esc</span> st√§nger panel</div>
          </div>

          <hr class="hr" />

          <div style="font-weight:900; margin-bottom:6px;">S√• funkar sidan</div>
          <ul class="muted small" style="margin:0 0 0 18px;">
            <li>√ñppnas med <span class="kbd">?id=mrX</span> fr√•n receptlistan.</li>
            <li>Underrecept kommer exakt fr√•n <span class="kbd">subRecipeIds</span>.</li>
            <li>Portioner skalar ingrediensm√§ngder (demo-basis: 25).</li>
            <li>Klicka ingrediensnamn f√∂r produktkort.</li>
            <li>Klimat & n√§ring visar CO‚ÇÇ + n√§ring + historik (fejkmodell).</li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- HERO -->
    <section class="hero" aria-label="Recept√∂versikt">
      <div class="flexBetween" style="align-items:flex-start;">
        <div style="min-width:240px;">
          <h1 class="heroTitle" id="h1">‚Äî</h1>
          <p class="heroSub" id="hSub">‚Äî</p>
        </div>

        <div class="chipsRow" aria-label="Snabbinfo" style="justify-content:flex-end; margin-top:6px;">
          <span class="badge badgeMuted" id="pillStatus">‚Äî</span>
          <span class="badge badgeMuted" id="pillSubs">‚Äî</span>
          <span class="badge badgeMuted" id="pillSize">‚Äî</span>
          <span class="badge badgeMuted" id="pillSupplier">‚Äî</span>
        </div>
      </div>

      <!-- S√∂k -->
      <div class="searchWrap" style="max-width:920px; width:100%; margin-top:12px;">
        <svg class="searchIcon" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M10 4a6 6 0 1 1 3.87 10.58l4.28 4.28-1.42 1.42-4.28-4.28A6 6 0 0 1 10 4m0 2a4 4 0 1 0 0 8a4 4 0 0 0 0-8Z"/>
        </svg>
        <input id="q" class="searchInput" type="search" placeholder="S√∂k i ingredienser‚Ä¶" autocomplete="off" />
        <span class="kbd" title="Snabbtangent">/</span>
      </div>
    </section>

    <!-- Sticky actions -->
    <div class="card mt16" style="padding:12px 14px; position:sticky; top:64px; z-index:10;">
      <div class="flexBetween" style="align-items:flex-start;">
        <div class="flex gap10" style="align-items:center; flex-wrap:wrap;">
          <span class="badge badgeMuted">SUPERSIDA</span>
          <span class="muted small" id="metaLine">‚Äî</span>
        </div>

        <div class="flex gap10" style="align-items:center; flex-wrap:wrap;">
          <div class="chip">
            <label for="portionSel">Portioner</label>
            <select id="portionSel">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>

          <div class="chip">
            <label for="sizeSel">Portionsstorlek</label>
            <select id="sizeSel">
              <option value="350 g">350 g</option>
              <option value="400 g">400 g</option>
              <option value="440 g">440 g</option>
              <option value="500 g" selected>500 g</option>
              <option value="550 g">550 g</option>
            </select>
          </div>

          <div class="chip">
            <label for="readySel">Beredd</label>
            <select id="readySel">
              <option value="no" selected>Nej</option>
              <option value="yes">Ja</option>
            </select>
          </div>
        </div>
      </div>

      <p class="muted small" id="saveNote" style="margin:10px 0 0 0;"></p>
    </div>

    <div class="grid grid2 mt16">

      <!-- LEFT: Underrecept cards -->
      <section class="card" style="padding:18px;" aria-label="Underrecept & ingredienser">
        <div class="flexBetween" style="align-items:flex-start; gap:12px;">
          <div>
            <h2 style="margin:0; font-size:16px; font-weight:900;">Underrecept</h2>
            <div class="muted small">Visar exakt de underrecept som m√•ltiden pekar p√•.</div>
          </div>

          <div class="flex gap10" style="align-items:center; flex-wrap:wrap;">
            <button class="btn" id="expandAllBtn" type="button">Expandera alla</button>
            <button class="btn" id="collapseAllBtn" type="button">F√§ll ihop</button>
            <button class="btn" id="goCooking" type="button">Visa tillagning</button>
          </div>
        </div>

        <hr class="hr" />

        <div class="muted small" id="subsHint">‚Äî</div>
        <div id="subsWrap" class="mt12"></div>

        <div class="muted small mt12">
          Tips: klicka p√• ingrediensnamn f√∂r produktkort.
        </div>
      </section>

      <!-- RIGHT: Cooking -->
      <aside class="card" style="padding:18px;" aria-label="Tillagning">
        <div class="flexBetween" style="align-items:flex-start; gap:12px;">
          <div>
            <h2 style="margin:0; font-size:16px; font-weight:900;">Tillagning</h2>
            <p class="muted small" style="margin-top:6px;">√ñversikt + per delrecept (l√§ser fr√•n fejkmodellens instructions).</p>
          </div>
          <span class="badge badgeMuted" id="cookBadge">‚Äî</span>
        </div>

        <div class="tabs mt12" role="tablist" aria-label="Tillagningsflikar" id="cookTabs"></div>

        <div class="card mt12" style="padding:14px; box-shadow:none;">
          <div class="muted small" id="cookHint">‚Äî</div>

          <div class="field mt12">
            <label for="cookTitle">Rubrik</label>
            <input class="input" id="cookTitle" type="text" />
          </div>

          <div class="field">
            <label for="cookDesc">Beskrivning</label>
            <textarea class="input" id="cookDesc" rows="3" style="resize:vertical;"></textarea>
          </div>

          <div class="field">
            <label for="cookSteps">Instruktioner (steg)</label>
            <textarea class="input" id="cookSteps" rows="9" style="resize:vertical;" placeholder="1. ‚Ä¶&#10;2. ‚Ä¶"></textarea>
          </div>

          <div class="field">
            <label for="cookNote">Notering</label>
            <textarea class="input" id="cookNote" rows="3" style="resize:vertical;" placeholder="Intern notering‚Ä¶"></textarea>
          </div>

          <button class="btn btnPrimary w100" id="saveCooking" type="button">Spara tillagning (demo)</button>
          <p class="muted small mt12" id="cookSaveNote"></p>

          <hr class="hr" />

          <div class="flexBetween">
            <div style="font-weight:900;">F√∂rhandsvisning</div>
            <span class="badge badgeMuted" id="cookStepsCount">‚Äî</span>
          </div>
          <ol class="muted small" id="cookPreview" style="margin:8px 0 0 18px;"></ol>
        </div>
      </aside>
    </div>

  </main>

  <!-- Product card popover -->
  <div id="prodPop"
       class="selectionPanel"
       role="dialog"
       aria-label="Produktkort"
       style="display:none;">
    <div class="selectionHeader">
      <div class="title" id="ppTitle">Produktkort</div>
      <button class="iconBtn" id="ppClose" type="button" aria-label="St√§ng">‚úï</button>
    </div>
    <div class="selectionBody" style="gap:12px;">
      <div style="display:flex; gap:12px; align-items:center;">
        <img id="ppImg" alt="" style="width:64px; height:64px; border-radius:14px; border:1px solid var(--border); background:var(--surface2);" />
        <div style="min-width:0;">
          <div id="ppDisplayName" style="font-weight:900; font-size:14px; line-height:1.2;">‚Äî</div>
          <div id="ppBrandLine" class="muted small" style="margin-top:4px;">‚Äî</div>
        </div>
      </div>

      <div class="card" style="padding:12px; box-shadow:none;">
        <div class="flexBetween">
          <div class="muted small">Artikel</div>
          <div id="ppArticle" style="font-weight:900;">‚Äî</div>
        </div>
        <div class="flexBetween mt12">
          <div class="muted small">GTIN</div>
          <div id="ppGtin" style="font-weight:900;">‚Äî</div>
        </div>
        <hr class="hr" />
        <div class="flexBetween">
          <div class="muted small">J√§mf√∂rpris</div>
          <div id="ppCompare" style="font-weight:900;">‚Äî</div>
        </div>
        <div class="flexBetween mt12">
          <div class="muted small">CO‚ÇÇe</div>
          <div id="ppCo2" style="font-weight:900;">‚Äî</div>
        </div>
        <div class="mt12" id="ppOfferWrap" style="display:none;">
          <span class="badge badgeOk" id="ppOffer">Anbud</span>
        </div>
      </div>

      <div class="muted small" id="ppSupplier">‚Äî</div>
    </div>
  </div>

  <!-- OVERLAY + DRAWER: Klimat & n√§ring -->
  <div class="overlay" id="overlay" aria-hidden="true"></div>
  <aside class="drawer" id="drawer" aria-label="Klimat & n√§ring">
    <div class="drawerHeader">
      <div>
        <div class="drawerTitle">Klimat & n√§ring</div>
        <div class="muted small" id="dSub">‚Äî</div>
      </div>
      <button class="iconBtn" id="dClose" title="St√§ng" aria-label="St√§ng">‚úï</button>
    </div>

    <div class="drawerBody">
      <div class="tabs" role="tablist" aria-label="Flikar">
        <button class="tab active" data-tab="climate" type="button">Klimat</button>
        <button class="tab" data-tab="energy" type="button">N√§ring</button>
        <button class="tab" data-tab="history" type="button">Historik</button>
      </div>

      <div id="tab_climate">
        <div class="card" style="padding:14px; box-shadow:none;">
          <div class="flexBetween">
            <div>
              <div style="font-weight:900;">CO‚ÇÇe totalt</div>
              <div class="muted small">M√•ltid (fejkmodell)</div>
            </div>
            <span class="badge badgeMuted" id="co2Total">‚Äî</span>
          </div>
          <hr class="hr" />
          <div class="flexBetween">
            <div>
              <div style="font-weight:900;">CO‚ÇÇe per portion</div>
              <div class="muted small">Baserat p√• portioner</div>
            </div>
            <span class="badge badgeMuted" id="co2Per">‚Äî</span>
          </div>
          <div class="muted small mt12" id="co2Note">‚Äî</div>
        </div>
      </div>

      <div id="tab_energy" style="display:none;">
        <div class="card" style="padding:14px; box-shadow:none;">
          <div style="font-weight:900;">N√§ring per portion</div>
          <div class="muted small">kcal / protein / fett / kolhydrater / salt</div>
          <hr class="hr" />

          <div class="flexBetween">
            <div class="muted small">Energi</div>
            <div style="font-weight:900;" id="nKcal">‚Äî</div>
          </div>
          <div class="flexBetween mt12">
            <div class="muted small">Protein</div>
            <div style="font-weight:900;" id="nProt">‚Äî</div>
          </div>
          <div class="flexBetween mt12">
            <div class="muted small">Fett</div>
            <div style="font-weight:900;" id="nFat">‚Äî</div>
          </div>
          <div class="flexBetween mt12">
            <div class="muted small">Kolhydrater</div>
            <div style="font-weight:900;" id="nCarb">‚Äî</div>
          </div>
          <div class="flexBetween mt12">
            <div class="muted small">Salt</div>
            <div style="font-weight:900;" id="nSalt">‚Äî</div>
          </div>

          <hr class="hr" />
          <div class="muted small">Per 100 g</div>
          <div class="muted small mt12" id="n100">‚Äî</div>
        </div>
      </div>

      <div id="tab_history" style="display:none;">
        <div class="card" style="padding:14px; box-shadow:none;">
          <div style="font-weight:900;">Leverant√∂r uppdaterade</div>
          <div class="muted small" id="supplierUpdatedAt">‚Äî</div>
          <hr class="hr" />
          <div style="font-weight:900;">√Ñndringslogg</div>
          <div class="muted small mt12" id="histBox">‚Äî</div>
        </div>
      </div>

    </div>
  </aside>

  <script type="module">
    import { getMockDB, expandMeal } from '../assets/js/app.js';

    const $ = (sel) => document.querySelector(sel);

    /* -----------------------------
       Small helpers (XSS-safe)
    ----------------------------- */
    function safeStr(v){ return (v === null || v === undefined) ? '' : String(v); }
    function uid(prefix){ return prefix + '_' + Math.random().toString(16).slice(2); }
    function clampNum(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function toNumMaybe(s){
      const n = Number(String(s).replace(',', '.').trim());
      return Number.isFinite(n) ? n : null;
    }

    function fmtKg(x){
      if (!Number.isFinite(x)) return '‚Äî';
      const v = Math.round(x * 100) / 100;
      return `${v.toFixed(2)} kg`;
    }
    function fmtG(x){
      if (!Number.isFinite(x)) return '‚Äî';
      const v = Math.round(x);
      return `${v} g`;
    }
    function fmtKcal(x){
      if (!Number.isFinite(x)) return '‚Äî';
      return `${Math.round(x)} kcal`;
    }
    function fmtGNum(x){
      if (!Number.isFinite(x)) return '‚Äî';
      const v = Math.round(x * 10) / 10;
      return `${v.toFixed(1)} g`;
    }

    function normalizeSteps(text){
      const raw = safeStr(text).trim();
      if (!raw) return [];
      return raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    }

    function setText(el, v){ el.textContent = safeStr(v); }

    /* -----------------------------
       DOM hooks
    ----------------------------- */
    const elBack = $('#backBtn');

    const helpBtn = $('#helpBtn');
    const helpPop = $('#helpPop');
    const helpClose = $('#helpClose');

    const elOverlay = $('#overlay');
    const elDrawer = $('#drawer');
    const elDClose = $('#dClose');
    const elClimateBtn = $('#climateBtn');

    const elH1 = $('#h1');
    const elHSub = $('#hSub');
    const elSubtitle = $('#subtitle');

    const pillStatus = $('#pillStatus');
    const pillSubs = $('#pillSubs');
    const pillSize = $('#pillSize');
    const pillSupplier = $('#pillSupplier');

    const elQ = $('#q');
    const subsHint = $('#subsHint');
    const subsWrap = $('#subsWrap');

    const expandAllBtn = $('#expandAllBtn');
    const collapseAllBtn = $('#collapseAllBtn');
    const goCooking = $('#goCooking');

    const portionSel = $('#portionSel');
    const sizeSel = $('#sizeSel');
    const saveBtn = $('#saveBtn');
    const saveNote = $('#saveNote');
    const metaLine = $('#metaLine');

    // Cooking
    const cookTabs = $('#cookTabs');
    const cookBadge = $('#cookBadge');
    const cookHint = $('#cookHint');
    const cookTitle = $('#cookTitle');
    const cookDesc = $('#cookDesc');
    const cookSteps = $('#cookSteps');
    const cookNote = $('#cookNote');
    const cookPreview = $('#cookPreview');
    const cookSaveNote = $('#cookSaveNote');
    const saveCooking = $('#saveCooking');
    const cookStepsCount = $('#cookStepsCount');

    // Drawer
    const drawerTabs = Array.from(document.querySelectorAll('.drawer .tab'));
    const tabViews = {
      climate: $('#tab_climate'),
      energy: $('#tab_energy'),
      history: $('#tab_history')
    };

    const co2Total = $('#co2Total');
    const co2Per = $('#co2Per');
    const co2Note = $('#co2Note');

    const nKcal = $('#nKcal');
    const nProt = $('#nProt');
    const nFat = $('#nFat');
    const nCarb = $('#nCarb');
    const nSalt = $('#nSalt');
    const n100 = $('#n100');

    const supplierUpdatedAt = $('#supplierUpdatedAt');
    const histBox = $('#histBox');
    const dSub = $('#dSub');

    // Product popover
    const prodPop = $('#prodPop');
    const ppClose = $('#ppClose');
    const ppTitle = $('#ppTitle');
    const ppImg = $('#ppImg');
    const ppDisplayName = $('#ppDisplayName');
    const ppBrandLine = $('#ppBrandLine');
    const ppArticle = $('#ppArticle');
    const ppGtin = $('#ppGtin');
    const ppCompare = $('#ppCompare');
    const ppCo2 = $('#ppCo2');
    const ppOfferWrap = $('#ppOfferWrap');
    const ppOffer = $('#ppOffer');
    const ppSupplier = $('#ppSupplier');

    /* -----------------------------
       Help popover
    ----------------------------- */
    let helpOpen = false;
    function openHelp(){
      helpOpen = true;
      helpPop.style.display = '';
      helpBtn.setAttribute('aria-expanded', 'true');
      setTimeout(() => {
        const onDoc = (e) => {
          if (!helpPop.contains(e.target) && e.target !== helpBtn){
            document.removeEventListener('mousedown', onDoc);
            closeHelp();
          }
        };
        document.addEventListener('mousedown', onDoc);
      }, 0);
    }
    function closeHelp(){
      helpOpen = false;
      helpPop.style.display = 'none';
      helpBtn.setAttribute('aria-expanded', 'false');
    }
    helpBtn.addEventListener('click', () => (helpOpen ? closeHelp() : openHelp()));
    helpClose.addEventListener('click', closeHelp);

    /* -----------------------------
       Drawer tabs + open/close
    ----------------------------- */
    function setDrawerTab(key){
      for (const [k, el] of Object.entries(tabViews)){
        el.style.display = (k === key) ? '' : 'none';
      }
      drawerTabs.forEach(t => t.classList.toggle('active', t.dataset.tab === key));
    }

    function openDrawer(){
      refreshDrawer();
      elOverlay.classList.add('open');
      elDrawer.classList.add('open');
      elOverlay.setAttribute('aria-hidden', 'false');
    }
    function closeDrawer(){
      elOverlay.classList.remove('open');
      elDrawer.classList.remove('open');
      elOverlay.setAttribute('aria-hidden', 'true');
    }

    elClimateBtn.addEventListener('click', () => {
      openDrawer();
      setDrawerTab('climate');
    });
    elOverlay.addEventListener('click', closeDrawer);
    elDClose.addEventListener('click', closeDrawer);
    drawerTabs.forEach(t => t.addEventListener('click', () => setDrawerTab(t.dataset.tab)));

    /* -----------------------------
       Product popover
    ----------------------------- */
    let prodOpen = false;
    function closeProdPop(){
      prodOpen = false;
      prodPop.style.display = 'none';
      prodPop.classList.remove('open');
    }
    function openProdPop(anchorEl, ingredient){
      const it = ingredient || {};

      setText(ppTitle, 'Produktkort');
      ppImg.src = safeStr(it.img || '');
      ppImg.alt = safeStr(it.name || '');

      setText(ppDisplayName, it.displayName || it.name || '‚Äî');
      setText(ppBrandLine, it.brandLine || (it.supplier?.supplierName ? it.supplier.supplierName : '‚Äî'));

      setText(ppArticle, it.articleNo || '‚Äî');
      setText(ppGtin, it.gtin || '‚Äî');
      setText(ppCompare, it.comparePrice || '‚Äî');
      setText(ppCo2, it.co2PerKgLabel || (it.co2ePerKg ? `${it.co2ePerKg} kg CO‚ÇÇe/kg` : '‚Äî'));

      const offer = safeStr(it.offerLabel || '').trim();
      if (offer){
        ppOfferWrap.style.display = '';
        setText(ppOffer, offer);
      } else {
        ppOfferWrap.style.display = 'none';
      }

      const supName = it?.supplier?.supplierName ? it.supplier.supplierName : '‚Äî';
      const supUpd = it?.supplierUpdatedAt ? it.supplierUpdatedAt : '‚Äî';
      setText(ppSupplier, `Leverant√∂r: ${supName} ‚Ä¢ Uppdaterad: ${supUpd}`);

      // position near click (fixed panel style)
      const r = anchorEl.getBoundingClientRect();
      const top = clampNum(Math.round(r.bottom + 10), 86, window.innerHeight - 220);
      const right = 18;
      prodPop.style.top = top + 'px';
      prodPop.style.right = right + 'px';

      prodOpen = true;
      prodPop.style.display = '';
      prodPop.classList.add('open');

      setTimeout(() => {
        const onDoc = (e) => {
          if (!prodPop.contains(e.target)){
            document.removeEventListener('mousedown', onDoc);
            closeProdPop();
          }
        };
        document.addEventListener('mousedown', onDoc);
      }, 0);
    }
    ppClose.addEventListener('click', closeProdPop);

    /* -----------------------------
       Load data
    ----------------------------- */
    const db = getMockDB();
    const params = new URLSearchParams(location.search);
    const id = params.get('id') || db.meals[0];

    const { meal } = expandMeal(db, id);
    const activeMeal = (meal && meal.type === 'meal') ? meal : db.byId.get(db.meals[0]);
    const expanded = expandMeal(db, activeMeal.id);

    // Demo: baseline portions for scaling
    const BASE_PORTIONS = 25;

    const state = {
      meal: expanded.meal,
      subs: Array.isArray(expanded.subs) ? expanded.subs.slice() : [],
      q: '',
      portions: parseInt(portionSel.value, 10) || BASE_PORTIONS,
      size: sizeSel.value,

      // Ingredient rows per subId (edit in session)
      rowsBySub: {},

      // collapse state per subId
      openBySub: {},

      // cooking: "meal" + each subId
      cook: {
        activeKey: 'meal',
        byKey: {} // { key: { title, desc, stepsText, note } }
      }
    };

    function initFromModel(){
      // rows per sub
      const rb = {};
      const ob = {};

      for (const s of state.subs){
        const ing = Array.isArray(s.ingredients) ? s.ingredients : [];
        rb[s.id] = ing.map((it) => {
          const qtyNum = toNumMaybe(it.qty);
          return {
            id: uid('row'),
            // keep original full ingredient object for product popover
            src: it,
            name: safeStr(it.name),
            unit: safeStr(it.unit || 'g'),
            baseQtyNum: qtyNum,          // numeric or null
            baseQtyRaw: safeStr(it.qty), // original string
            bestBefore: ''               // UI-only demo
          };
        });
        ob[s.id] = true; // start expanded
      }

      state.rowsBySub = rb;
      state.openBySub = ob;

      // cook from model instructions
      const mIns = state.meal.instructions || {};
      state.cook.byKey['meal'] = {
        title: safeStr(mIns.title || state.meal.name),
        desc: safeStr(mIns.desc || state.meal.desc || ''),
        stepsText: Array.isArray(mIns.steps) ? mIns.steps.join('\n') : safeStr(mIns.steps || ''),
        note: safeStr(mIns.note || '')
      };

      for (const s of state.subs){
        const ins = s.instructions || {};
        state.cook.byKey[s.id] = {
          title: safeStr(ins.title || s.name),
          desc: safeStr(ins.desc || s.desc || ''),
          stepsText: Array.isArray(ins.steps) ? ins.steps.join('\n') : safeStr(ins.steps || ''),
          note: safeStr(ins.note || '')
        };
      }
    }

    /* -----------------------------
       Render header
    ----------------------------- */
    function renderHeader(){
      setText(elH1, state.meal.name || '‚Äî');
      setText(elSubtitle, state.meal.name || '‚Äî');
      setText(elHSub, state.meal.desc || 'Arbetsyta f√∂r m√•ltiden.');

      // status pill
      const isActive = state.meal.status === 'active';
      setText(pillStatus, isActive ? 'Aktiv' : 'Inaktiv');
      pillStatus.className = 'badge ' + (isActive ? 'badgeOk' : 'badgeMuted');

      setText(pillSubs, `${state.subs.length} underrecept`);
      setText(pillSize, state.meal.size || state.size || '‚Äî');

      const supName = state.meal?.supplier?.supplierName || '‚Äî';
      const supUpd = state.meal.supplierUpdatedAt || '‚Äî';
      setText(pillSupplier, `Leverant√∂r: ${supName} ‚Ä¢ ${supUpd}`);

      const upd = state.meal.updatedAt || '‚Äî';
      const price = state.meal.price || '‚Äî';
      setText(metaLine, `Uppdaterad: ${upd} ‚Ä¢ Pris: ${price}`);

      setText(subsHint, state.subs.length ? `Ing√•r i m√•ltiden:` : 'Inga underrecept kopplade.');
    }

    /* -----------------------------
       Scaling
    ----------------------------- */
    function scaleQty(row){
      const mult = (state.portions || BASE_PORTIONS) / BASE_PORTIONS;
      if (row.baseQtyNum === null || row.baseQtyNum === undefined) {
        // fallback: leave original string
        return row.baseQtyRaw;
      }
      const scaled = row.baseQtyNum * mult;

      // small formatting rules
      if (row.unit === 'st') {
        return String(Math.max(0, Math.round(scaled)));
      }
      if (row.unit === 'kg' || row.unit === 'l') {
        const v = Math.round(scaled * 100) / 100;
        return v.toFixed(2).replace('.', ',');
      }
      // g/dl/others
      const v = Math.round(scaled * 10) / 10;
      return String(v).replace('.', ',');
    }

    /* -----------------------------
       Filter
    ----------------------------- */
    function matchesQ(row){
      const q = state.q.trim().toLowerCase();
      if (!q) return true;
      const hay = `${row.name} ${row.unit}`.toLowerCase();
      return hay.includes(q);
    }

    /* -----------------------------
       Underrecept cards
    ----------------------------- */
    function renderSubs(){
      subsWrap.textContent = '';

      for (const s of state.subs){
        const card = document.createElement('div');
        card.className = 'card';
        card.style.padding = '14px';
        card.style.boxShadow = 'none';
        card.style.border = '1px solid var(--border)';
        card.style.borderRadius = '16px';
        card.style.marginTop = '12px';

        // header row
        const head = document.createElement('div');
        head.className = 'flexBetween';
        head.style.alignItems = 'flex-start';
        head.style.gap = '12px';

        const left = document.createElement('div');
        left.style.minWidth = '0';

        const titleRow = document.createElement('div');
        titleRow.className = 'flex';
        titleRow.style.alignItems = 'center';
        titleRow.style.gap = '8px';
        titleRow.style.flexWrap = 'wrap';

        const h = document.createElement('div');
        h.style.fontWeight = '900';
        h.style.fontSize = '15px';
        h.textContent = s.name;

        const st = document.createElement('span');
        st.className = 'badge ' + (s.status === 'active' ? 'badgeOk' : 'badgeMuted');
        st.textContent = s.status === 'active' ? 'Aktiv' : 'Inaktiv';

        titleRow.appendChild(h);
        titleRow.appendChild(st);

        const meta = document.createElement('div');
        meta.className = 'muted small';
        const supUpd = s.supplierUpdatedAt || '‚Äî';
        const price = s.price || '‚Äî';
        meta.textContent = `Uppdaterad: ${supUpd} ‚Ä¢ Pris: ${price}`;

        const desc = document.createElement('div');
        desc.className = 'muted small';
        desc.style.marginTop = '6px';
        desc.textContent = s.desc || '‚Äî';

        left.appendChild(titleRow);
        left.appendChild(meta);
        left.appendChild(desc);

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.gap = '8px';
        right.style.flexWrap = 'wrap';
        right.style.alignItems = 'center';

        const btnCook = document.createElement('button');
        btnCook.className = 'btn';
        btnCook.type = 'button';
        btnCook.textContent = 'Tillagning';
        btnCook.addEventListener('click', () => setCookTab(s.id));

        const btnToggle = document.createElement('button');
        btnToggle.className = 'btn';
        btnToggle.type = 'button';
        btnToggle.textContent = state.openBySub[s.id] ? 'F√§ll ihop' : 'Expandera';
        btnToggle.addEventListener('click', () => {
          state.openBySub[s.id] = !state.openBySub[s.id];
          renderSubs();
        });

        right.appendChild(btnCook);
        right.appendChild(btnToggle);

        head.appendChild(left);
        head.appendChild(right);
        card.appendChild(head);

        if (state.openBySub[s.id]) {
          // stats row (CO2 + kcal if available)
          const statRow = document.createElement('div');
          statRow.className = 'chipsRow';
          statRow.style.marginTop = '12px';

          const co2 = s.co2 || {};
          const nutr = s.nutrition || {};
          const kcal = nutr?.perPortion?.kcal;

          const b1 = document.createElement('span');
          b1.className = 'badge badgeMuted';
          b1.textContent = `CO‚ÇÇ/portion: ${Number.isFinite(co2.perPortionKg) ? fmtKg(co2.perPortionKg) : '‚Äî'}`;

          const b2 = document.createElement('span');
          b2.className = 'badge badgeMuted';
          b2.textContent = `CO‚ÇÇ totalt: ${Number.isFinite(co2.totalKg) ? fmtKg(co2.totalKg) : '‚Äî'}`;

          const b3 = document.createElement('span');
          b3.className = 'badge badgeMuted';
          b3.textContent = `Kcal/portion: ${Number.isFinite(kcal) ? fmtKcal(kcal) : '‚Äî'}`;

          statRow.appendChild(b1);
          statRow.appendChild(b2);
          statRow.appendChild(b3);
          card.appendChild(statRow);

          // table
          const wrap = document.createElement('div');
          wrap.className = 'card mt12 tableCard';
          wrap.style.boxShadow = 'none';
          wrap.style.overflow = 'hidden';

          const table = document.createElement('table');
          table.className = 'table';
          table.setAttribute('aria-label', `Ingredienser f√∂r ${s.name}`);

          const thead = document.createElement('thead');
          const trh = document.createElement('tr');

          const cols = [
            { label: 'Ingrediens', w: '44%' },
            { label: 'M√§ngd', w: '16%' },
            { label: 'Enhet', w: '14%' },
            { label: 'B√§st f√∂re', w: '20%' },
            { label: '‚Äî', w: '6%', actions: true },
          ];

          cols.forEach(c => {
            const th = document.createElement('th');
            th.textContent = c.label;
            th.style.width = c.w;
            if (c.actions) th.className = 'actions';
            trh.appendChild(th);
          });

          thead.appendChild(trh);

          const tbody = document.createElement('tbody');
          const rows = (state.rowsBySub[s.id] || []).filter(matchesQ);

          for (const r of rows){
            const tr = document.createElement('tr');

            const tdName = document.createElement('td');
            const nameBtn = document.createElement('button');
            nameBtn.type = 'button';
            nameBtn.className = 'btn btnGhost';
            nameBtn.style.padding = '6px 8px';
            nameBtn.style.borderRadius = '10px';
            nameBtn.style.fontWeight = '900';
            nameBtn.style.textAlign = 'left';
            nameBtn.style.width = '100%';
            nameBtn.textContent = r.name;
            nameBtn.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              openProdPop(nameBtn, r.src || {});
            });
            tdName.appendChild(nameBtn);

            const tdQty = document.createElement('td');
            const qty = document.createElement('input');
            qty.className = 'input';
            qty.value = scaleQty(r);
            qty.addEventListener('input', () => {
              // edit becomes new base (relative to BASE_PORTIONS) to keep scaling stable
              const v = toNumMaybe(qty.value);
              if (v === null) {
                r.baseQtyNum = null;
                r.baseQtyRaw = qty.value;
              } else {
                const mult = (state.portions || BASE_PORTIONS) / BASE_PORTIONS;
                const base = mult ? (v / mult) : v;
                r.baseQtyNum = base;
                r.baseQtyRaw = qty.value;
              }
            });
            tdQty.appendChild(qty);

            const tdUnit = document.createElement('td');
            const unit = document.createElement('select');
            ['g','kg','l','dl','st'].forEach(u => {
              const o = document.createElement('option');
              o.value = u;
              o.textContent = u;
              if (r.unit === u) o.selected = true;
              unit.appendChild(o);
            });
            unit.addEventListener('change', () => {
              r.unit = unit.value;
              renderSubs();
            });
            tdUnit.appendChild(unit);

            const tdBB = document.createElement('td');
            const bb = document.createElement('input');
            bb.className = 'input';
            bb.type = 'date';
            bb.value = r.bestBefore;
            bb.addEventListener('change', () => r.bestBefore = bb.value);
            tdBB.appendChild(bb);

            const tdAct = document.createElement('td');
            tdAct.className = 'actions';

            const del = document.createElement('button');
            del.className = 'iconBtn';
            del.type = 'button';
            del.title = 'Ta bort';
            del.textContent = 'üóë';
            del.addEventListener('click', () => {
              state.rowsBySub[s.id] = (state.rowsBySub[s.id] || []).filter(x => x !== r);
              renderSubs();
            });

            tdAct.appendChild(del);

            tr.appendChild(tdName);
            tr.appendChild(tdQty);
            tr.appendChild(tdUnit);
            tr.appendChild(tdBB);
            tr.appendChild(tdAct);

            tbody.appendChild(tr);
          }

          table.appendChild(thead);
          table.appendChild(tbody);
          wrap.appendChild(table);
          card.appendChild(wrap);

          // footer hint
          const hint = document.createElement('div');
          hint.className = 'muted small mt12';
          hint.textContent = `Visar ${rows.length} rad(er)` + (state.q.trim() ? ` (filter: ‚Äú${state.q.trim()}‚Äù)` : '');
          card.appendChild(hint);
        }

        subsWrap.appendChild(card);
      }
    }

    /* -----------------------------
       Cooking tabs
    ----------------------------- */
    function renderCookTabs(){
      cookTabs.textContent = '';

      const mkBtn = (key, label) => {
        const b = document.createElement('button');
        b.className = 'tab' + (state.cook.activeKey === key ? ' active' : '');
        b.type = 'button';
        b.dataset.key = key;
        b.textContent = label;
        b.addEventListener('click', () => setCookTab(key));
        return b;
      };

      cookTabs.appendChild(mkBtn('meal', '√ñversikt'));
      for (const s of state.subs){
        cookTabs.appendChild(mkBtn(s.id, s.name));
      }

      const activeLabel = (state.cook.activeKey === 'meal')
        ? '√ñversikt'
        : (state.subs.find(x => x.id === state.cook.activeKey)?.name || 'Delrecept');

      cookBadge.textContent = activeLabel;
    }

    function renderCookEditor(){
      const key = state.cook.activeKey;
      const data = state.cook.byKey[key] || { title:'', desc:'', stepsText:'', note:'' };

      cookTitle.value = data.title;
      cookDesc.value = data.desc;
      cookSteps.value = data.stepsText;
      cookNote.value = data.note;

      cookHint.textContent = (key === 'meal')
        ? '√ñversikt f√∂r hela m√•ltiden (montering/servering).'
        : 'Tillagning f√∂r valt underrecept.';

      // preview
      cookPreview.textContent = '';
      const items = normalizeSteps(data.stepsText);
      cookStepsCount.textContent = items.length ? `${items.length} steg` : '‚Äî';

      if (items.length === 0){
        const li = document.createElement('li');
        li.textContent = '‚Äî';
        cookPreview.appendChild(li);
      } else {
        items.forEach(line => {
          const li = document.createElement('li');
          li.textContent = line;
          cookPreview.appendChild(li);
        });
      }
    }

    function setCookTab(key){
      if (!state.cook.byKey[key]) return;
      state.cook.activeKey = key;
      renderCookTabs();
      renderCookEditor();
      try { cookTabs.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch {}
    }

    function saveCookActive(){
      const key = state.cook.activeKey;
      if (!state.cook.byKey[key]) return;

      state.cook.byKey[key] = {
        title: cookTitle.value.trim() || state.cook.byKey[key].title,
        desc: cookDesc.value,
        stepsText: cookSteps.value,
        note: cookNote.value
      };

      cookSaveNote.textContent = 'Sparat (demo).';
      setTimeout(() => { cookSaveNote.textContent = ''; }, 2000);
      renderCookEditor();
    }

    saveCooking.addEventListener('click', saveCookActive);
    goCooking.addEventListener('click', () => setCookTab('meal'));

    /* -----------------------------
       Drawer content from model
    ----------------------------- */
    function refreshDrawer(){
      const p = state.portions || BASE_PORTIONS;
      const size = state.meal.size || state.size || '‚Äî';
      dSub.textContent = `${p} portioner ‚Ä¢ ${size}`;

      const c = state.meal.co2 || {};
      co2Total.textContent = Number.isFinite(c.totalKg) ? fmtKg(c.totalKg) : '‚Äî';
      co2Per.textContent = Number.isFinite(c.perPortionKg) ? fmtKg(c.perPortionKg) : '‚Äî';
      co2Note.textContent = safeStr(c.note || '‚Äî');

      const n = state.meal.nutrition || {};
      const pp = n.perPortion || {};
      const p100 = n.per100g || {};

      nKcal.textContent = Number.isFinite(pp.kcal) ? fmtKcal(pp.kcal) : '‚Äî';
      nProt.textContent = Number.isFinite(pp.proteinG) ? fmtGNum(pp.proteinG) : '‚Äî';
      nFat.textContent = Number.isFinite(pp.fatG) ? fmtGNum(pp.fatG) : '‚Äî';
      nCarb.textContent = Number.isFinite(pp.carbsG) ? fmtGNum(pp.carbsG) : '‚Äî';
      nSalt.textContent = Number.isFinite(pp.saltG) ? fmtGNum(pp.saltG) : '‚Äî';

      const s100 = [
        `kcal ${Number.isFinite(p100.kcal) ? Math.round(p100.kcal) : '‚Äî'}`,
        `protein ${Number.isFinite(p100.proteinG) ? (Math.round(p100.proteinG*10)/10) : '‚Äî'} g`,
        `fett ${Number.isFinite(p100.fatG) ? (Math.round(p100.fatG*10)/10) : '‚Äî'} g`,
        `kolh ${Number.isFinite(p100.carbsG) ? (Math.round(p100.carbsG*10)/10) : '‚Äî'} g`,
        `salt ${Number.isFinite(p100.saltG) ? (Math.round(p100.saltG*10)/10) : '‚Äî'} g`
      ];
      n100.textContent = s100.join(' ‚Ä¢ ');

      supplierUpdatedAt.textContent = safeStr(state.meal.supplierUpdatedAt || '‚Äî');

      const arr = Array.isArray(state.meal.history) ? state.meal.history : [];
      histBox.textContent = '';
      if (arr.length === 0){
        histBox.textContent = '‚Äî';
      } else {
        for (const h of arr){
          const row = document.createElement('div');
          row.style.padding = '10px 0';
          row.style.borderBottom = '1px solid var(--border)';
          row.textContent = `${safeStr(h.date)} ‚Ä¢ ${safeStr(h.change)}`;
          histBox.appendChild(row);
        }
      }
    }

    /* -----------------------------
       Global events
    ----------------------------- */
    elBack.addEventListener('click', () => history.back());

    window.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== elQ){
        e.preventDefault();
        elQ.focus();
      }
      if (e.key === 'Escape'){
        closeDrawer();
        closeHelp();
        closeProdPop();
      }
    });

    elQ.addEventListener('input', () => {
      state.q = elQ.value;
      renderSubs();
    });

    portionSel.addEventListener('change', () => {
      state.portions = parseInt(portionSel.value, 10) || BASE_PORTIONS;
      refreshDrawer();
      renderSubs();
    });

    sizeSel.addEventListener('change', () => {
      state.size = sizeSel.value;
      pillSize.textContent = state.meal.size || state.size || '‚Äî';
      refreshDrawer();
    });

    expandAllBtn.addEventListener('click', () => {
      for (const s of state.subs) state.openBySub[s.id] = true;
      renderSubs();
    });

    collapseAllBtn.addEventListener('click', () => {
      for (const s of state.subs) state.openBySub[s.id] = false;
      renderSubs();
    });

    saveBtn.addEventListener('click', () => {
      saveNote.textContent = 'Sparat (demo).';
      setTimeout(() => { saveNote.textContent = ''; }, 2200);
    });

    /* -----------------------------
       Boot
    ----------------------------- */
    initFromModel();
    renderHeader();
    renderSubs();
    renderCookTabs();
    renderCookEditor();
    setDrawerTab('climate');
  </script>

</body>
</html>
