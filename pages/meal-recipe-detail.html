<!-- ============================================================
     FIL: pages/meal-recipe-detail.html  (HEL FIL)
     Sida 4: M√•ltidsrecept detalj / arbetsyta
     Patch:
       - L√§s ?id= och ladda m√•ltidsrecept fr√•n FEJKDATA (assets/js/app.js)
       - Visa underrecept + ingredienser
       - Flytta s√∂k till hero/arbetsyta (inte i topbar)
       - Hj√§lp-popover i topbar
     Policy: statisk GitHub Pages, inga externa libs, XSS-safe (textContent)
============================================================ -->
<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kostdata ‚Äî M√•ltidsrecept detalj</title>
  <link rel="stylesheet" href="../assets/css/main.css" />
</head>
<body>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <button class="backBtn" id="backBtn" title="Tillbaka" aria-label="Tillbaka">‚Üê</button>
        <div>
          <div class="pageTitle">M√•ltidsrecept</div>
          <div class="muted small" id="subtitle">Detaljvy</div>
        </div>
      </div>

      <!-- s√∂k flyttat ner -->
      <div class="centerSlot"></div>

      <div class="rightSlot" style="position:relative;">
        <button class="btn" id="helpBtn" type="button" aria-haspopup="dialog" aria-expanded="false">Hj√§lp</button>
        <a class="btn" href="./recipes.html" title="Receptlista">Recept</a>
        <button class="btn" id="climateBtn">Klimat & n√§ring</button>
        <button class="btn btnPrimary" id="saveBtn">Spara</button>

        <!-- Hj√§lpruta (popover) -->
        <div id="helpPop"
             class="card"
             role="dialog"
             aria-label="Hj√§lp"
             style="
               display:none;
               position:absolute;
               right:0;
               top:48px;
               width:min(380px, 92vw);
               padding:14px;
               box-shadow: var(--shadow2);
               z-index: 60;">
          <div class="flexBetween">
            <div style="font-weight:900;">Snabbhj√§lp</div>
            <button class="iconBtn" id="helpClose" type="button" aria-label="St√§ng hj√§lp">‚úï</button>
          </div>

          <div class="muted small mt12">
            <div><span class="kbd">/</span> fokuserar s√∂k</div>
            <div><span class="kbd">Esc</span> st√§nger panel</div>
          </div>

          <hr class="hr" />

          <div style="font-weight:900; margin-bottom:6px;">S√• funkar sidan</div>
          <ul class="muted small" style="margin:0 0 0 18px;">
            <li>Sidan √∂ppnas med <span class="kbd">?id=mrX</span> fr√•n Receptlistan.</li>
            <li>Du ser underrecept + ingredienser i listan.</li>
            <li>S√∂k filtrerar ingredienslistan.</li>
            <li>Klimat & n√§ring √∂ppnas i eget f√∂nster (h√∂gerpanel).</li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- HERO / arbetsyta -->
    <section class="hero">
      <h1 class="heroTitle" id="h1">M√•ltidsrecept</h1>
      <p class="heroSub" id="hSub">Arbetsyta f√∂r m√•ltiden. Underrecept visas tydligt.</p>

      <!-- S√∂k h√§r (inte topbar) -->
      <div class="searchWrap" style="max-width:920px; width:100%; margin-top:12px;">
        <svg class="searchIcon" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M10 4a6 6 0 1 1 3.87 10.58l4.28 4.28-1.42 1.42-4.28-4.28A6 6 0 0 1 10 4m0 2a4 4 0 1 0 0 8a4 4 0 0 0 0-8Z"/>
        </svg>
        <input id="q" class="searchInput" type="search" placeholder="S√∂k i ingredienser‚Ä¶" autocomplete="off" />
        <span class="kbd" title="Snabbtangent">/</span>
      </div>

      <div class="chipsRow" aria-label="Snabbinfo" style="margin-top:12px;">
        <span class="badge badgeMuted" id="pillStatus">‚Äî</span>
        <span class="badge badgeMuted" id="pillSubs">‚Äî</span>
        <span class="badge badgeMuted" id="pillSize">‚Äî</span>
      </div>
    </section>

    <!-- Sticky actions (under hero) -->
    <div class="card mt16" style="padding:12px 14px; position:sticky; top:64px; z-index:10;">
      <div class="flexBetween">
        <div class="flex gap10" style="align-items:center; flex-wrap:wrap;">
          <span class="badge badgeMuted">MVP</span>
          <span class="muted small">√Ñndringar sparas som demo i minne (session).</span>
        </div>

        <div class="flex gap10" style="align-items:center; flex-wrap:wrap;">
          <div class="chip">
            <label for="portionSel">Portioner</label>
            <select id="portionSel">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>

          <div class="chip">
            <label for="sizeSel">Portionsstorlek</label>
            <select id="sizeSel">
              <option value="350 g">350 g</option>
              <option value="400 g">400 g</option>
              <option value="440 g">440 g</option>
              <option value="500 g" selected>500 g</option>
              <option value="550 g">550 g</option>
            </select>
          </div>

          <div class="chip">
            <label for="readySel">Beredd</label>
            <select id="readySel">
              <option value="no" selected>Nej</option>
              <option value="yes">Ja</option>
            </select>
          </div>
        </div>
      </div>

      <p class="muted small" id="saveNote" style="margin:10px 0 0 0;"></p>
    </div>

    <div class="grid grid2 mt16">

      <!-- LEFT: Underrecept + Ingredienser -->
      <section class="card" style="padding:18px;">
        <div class="flexBetween">
          <div>
            <h2 style="margin:0; font-size:16px; font-weight:900;">Underrecept & ingredienser</h2>
            <div class="muted small">Underrecept visas f√∂rst. Ingredienser filtreras av s√∂kf√§ltet.</div>
          </div>
          <button class="btn" id="addRow">+ L√§gg till</button>
        </div>

        <hr class="hr" />

        <div class="card" style="padding:14px; box-shadow:none;">
          <div style="font-weight:900;">Underrecept</div>
          <div class="muted small" id="subsHint" style="margin-top:6px;">‚Äî</div>
          <ul id="subsList" style="margin:10px 0 0 18px;"></ul>
        </div>

        <div class="card mt16 tableCard" style="box-shadow:none;">
          <table class="table" aria-label="Ingredienser">
            <thead>
              <tr>
                <th style="width:44%;">Ingrediens</th>
                <th style="width:18%;">M√§ngd</th>
                <th style="width:18%;">Enhet</th>
                <th style="width:14%;">K√§lla</th>
                <th class="actions" style="width:6%;">‚Äî</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="muted small mt12">
          Tips: skriv <span class="kbd">/</span> f√∂r att s√∂ka i listan.
        </div>
      </section>

      <!-- RIGHT: Text / instruktioner -->
      <aside class="card" style="padding:18px;">
        <h2 style="margin:0; font-size:16px; font-weight:900;">G√∂r s√• h√§r</h2>
        <p class="muted small" style="margin-top:6px;">H√•ll instruktioner h√§r. Klimat/n√§ring √∂ppnas i eget f√∂nster.</p>

        <div class="field mt16">
          <label for="title">Rubrik</label>
          <input class="input" id="title" type="text" />
        </div>

        <div class="field">
          <label for="desc">Beskrivning</label>
          <textarea class="input" id="desc" rows="4" style="resize:vertical;"></textarea>
        </div>

        <div class="field">
          <label for="steps">Instruktioner</label>
          <textarea class="input" id="steps" rows="10" style="resize:vertical;"></textarea>
        </div>

        <div class="field">
          <label for="note">Notering</label>
          <textarea class="input" id="note" rows="4" style="resize:vertical;" placeholder="Intern notering‚Ä¶"></textarea>
        </div>

        <button class="btn btnPrimary w100" id="saveText">Spara text (demo)</button>
        <p class="muted small mt12" id="textNote"></p>
      </aside>

    </div>

  </main>

  <!-- OVERLAY + DRAWER: Klimat & n√§ring -->
  <div class="overlay" id="overlay" aria-hidden="true"></div>
  <aside class="drawer" id="drawer" aria-label="Klimat & n√§ring">
    <div class="drawerHeader">
      <div>
        <div class="drawerTitle">Klimat & n√§ring</div>
        <div class="muted small" id="dSub">‚Äî</div>
      </div>
      <button class="iconBtn" id="dClose" title="St√§ng" aria-label="St√§ng">‚úï</button>
    </div>

    <div class="drawerBody">
      <div class="tabs" role="tablist" aria-label="Flikar">
        <button class="tab active" data-tab="climate" type="button">Klimat</button>
        <button class="tab" data-tab="energy" type="button">Energi</button>
        <button class="tab" data-tab="history" type="button">Historik</button>
      </div>

      <div id="tab_climate">
        <div class="card" style="padding:14px; box-shadow:none;">
          <div class="flexBetween">
            <div>
              <div style="font-weight:900;">CO‚ÇÇe totalt</div>
              <div class="muted small">Ber√§knad (demo)</div>
            </div>
            <span class="badge badgeMuted" id="co2Total">‚Äî</span>
          </div>
          <hr class="hr" />
          <div class="flexBetween">
            <div>
              <div style="font-weight:900;">CO‚ÇÇe per portion</div>
              <div class="muted small">Baserat p√• portioner</div>
            </div>
            <span class="badge badgeMuted" id="co2Per">‚Äî</span>
          </div>
        </div>
      </div>

      <div id="tab_energy" style="display:none;">
        <div class="card" style="padding:14px; box-shadow:none;">
          <div class="flexBetween">
            <div>
              <div style="font-weight:900;">Energidistribution</div>
              <div class="muted small">Fett / Kolhydrater / Protein</div>
            </div>
            <span class="badge badgeMuted" id="energyDist">‚Äî</span>
          </div>
          <hr class="hr" />
          <div class="flexBetween">
            <div>
              <div style="font-weight:900;">M√•ltidsstorlek</div>
              <div class="muted small">Portionsvikt</div>
            </div>
            <span class="badge badgeMuted" id="mealSize">‚Äî</span>
          </div>
        </div>
      </div>

      <div id="tab_history" style="display:none;">
        <p class="muted small">Visar datum + vad som √§ndrades (demo).</p>
        <div class="card" style="padding:14px; box-shadow:none;" id="histBox"></div>
      </div>

    </div>
  </aside>

  <script type="module">
    import { getMockDB, expandMeal } from '../assets/js/app.js';

    const $ = (sel) => document.querySelector(sel);

    // Help popover
    const helpBtn = $('#helpBtn');
    const helpPop = $('#helpPop');
    const helpClose = $('#helpClose');
    function openHelp(){
      helpPop.style.display = '';
      helpBtn.setAttribute('aria-expanded', 'true');
      setTimeout(() => {
        const onDoc = (e) => {
          if (!helpPop.contains(e.target) && e.target !== helpBtn){
            document.removeEventListener('mousedown', onDoc);
            closeHelp();
          }
        };
        document.addEventListener('mousedown', onDoc);
      }, 0);
    }
    function closeHelp(){
      helpPop.style.display = 'none';
      helpBtn.setAttribute('aria-expanded', 'false');
    }
    helpBtn.addEventListener('click', () => {
      const open = helpPop.style.display !== 'none' && helpPop.style.display !== '';
      if (open) closeHelp(); else openHelp();
    });
    helpClose.addEventListener('click', closeHelp);

    // Drawer tabs
    const tabs = Array.from(document.querySelectorAll('.drawer .tab'));
    const tabViews = {
      climate: $('#tab_climate'),
      energy: $('#tab_energy'),
      history: $('#tab_history')
    };
    function setTab(key){
      for (const [k, el] of Object.entries(tabViews)){
        el.style.display = (k === key) ? '' : 'none';
      }
      tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === key));
    }

    // Elements
    const elBack = $('#backBtn');
    const elQ = $('#q');
    const elTbody = $('#tbody');

    const elOverlay = $('#overlay');
    const elDrawer = $('#drawer');
    const elDClose = $('#dClose');
    const elClimateBtn = $('#climateBtn');

    const elH1 = $('#h1');
    const elHSub = $('#hSub');
    const elSubtitle = $('#subtitle');

    const pillStatus = $('#pillStatus');
    const pillSubs = $('#pillSubs');
    const pillSize = $('#pillSize');

    const subsHint = $('#subsHint');
    const subsList = $('#subsList');

    const title = $('#title');
    const desc = $('#desc');
    const steps = $('#steps');
    const note = $('#note');

    const portionSel = $('#portionSel');
    const sizeSel = $('#sizeSel');
    const saveBtn = $('#saveBtn');
    const saveNote = $('#saveNote');

    // Load from ?id=
    const db = getMockDB();
    const params = new URLSearchParams(location.search);
    const id = params.get('id') || db.meals[0]; // fallback f√∂rsta m√•ltiden

    const { meal, subs } = expandMeal(db, id);

    // Fail-closed-ish: om id inte √§r m√•ltid
    const activeMeal = (meal && meal.type === 'meal') ? meal : db.byId.get(db.meals[0]);
    const expanded = expandMeal(db, activeMeal.id);

    const state = {
      meal: expanded.meal,
      subs: expanded.subs,
      q: '',
      // ingredienser i tabell = meal-level + (valfritt) subs-ingredienser sammanfattade
      rows: [],
      editsText: {
        title: expanded.meal.name,
        desc: expanded.meal.desc || '',
        steps: '1. F√∂rbered ingredienser.\n2. Tillaga enligt rutin.\n3. Smaka av.\n4. Servera.',
        note: ''
      },
      portions: parseInt(portionSel.value, 10) || 25,
      size: sizeSel.value
    };

    function buildRows(){
      // Meal-level ingredienser (k√§lla = M√•ltid)
      const out = [];
      const mIng = Array.isArray(state.meal.ingredients) ? state.meal.ingredients : [];
      for (const it of mIng){
        out.push({
          id: 'm_' + Math.random().toString(16).slice(2),
          name: it.name,
          qty: String(it.qty ?? ''),
          unit: String(it.unit ?? ''),
          source: 'M√•ltid'
        });
      }
      // Underrecept ingredienser (k√§lla = underrecept namn) ‚Äì h√•ller det enkelt: 1 rad per ingrediens
      for (const s of state.subs){
        const sIng = Array.isArray(s.ingredients) ? s.ingredients : [];
        for (const it of sIng){
          out.push({
            id: 's_' + Math.random().toString(16).slice(2),
            name: it.name,
            qty: String(it.qty ?? ''),
            unit: String(it.unit ?? ''),
            source: s.name
          });
        }
      }
      state.rows = out;
    }

    function renderHeader(){
      elH1.textContent = state.meal.name;
      elHSub.textContent = state.meal.desc ? state.meal.desc : 'Arbetsyta f√∂r m√•ltiden.';
      elSubtitle.textContent = state.meal.name;

      pillStatus.textContent = state.meal.status === 'active' ? 'Aktiv' : 'Inaktiv';
      pillStatus.className = 'badge ' + (state.meal.status === 'active' ? 'badgeOk' : 'badgeMuted');

      pillSubs.textContent = `${state.subs.length} underrecept`;
      pillSize.textContent = state.meal.size || state.size || '‚Äî';

      subsHint.textContent = state.subs.length ? 'Ing√•r i m√•ltiden:' : 'Inga underrecept kopplade.';
      subsList.textContent = '';
      for (const s of state.subs){
        const li = document.createElement('li');
        li.textContent = s.name + (s.status === 'inactive' ? ' (inaktiv)' : '');
        subsList.appendChild(li);
      }
    }

    function renderText(){
      title.value = state.editsText.title;
      desc.value = state.editsText.desc;
      steps.value = state.editsText.steps;
      note.value = state.editsText.note;
    }

    function matchesRow(r){
      const q = state.q.trim().toLowerCase();
      if (!q) return true;
      return (`${r.name} ${r.source} ${r.unit}`).toLowerCase().includes(q);
    }

    function renderTable(){
      elTbody.textContent = '';
      for (const r of state.rows.filter(matchesRow)){
        const tr = document.createElement('tr');

        const tdName = document.createElement('td');
        tdName.textContent = r.name;

        const tdQty = document.createElement('td');
        const qty = document.createElement('input');
        qty.className = 'input';
        qty.value = r.qty;
        qty.addEventListener('input', () => r.qty = qty.value);
        tdQty.appendChild(qty);

        const tdUnit = document.createElement('td');
        const unit = document.createElement('select');
        ['g','kg','l','dl','st'].forEach(u => {
          const o = document.createElement('option');
          o.value = u;
          o.textContent = u;
          if (r.unit === u) o.selected = true;
          unit.appendChild(o);
        });
        unit.addEventListener('change', () => r.unit = unit.value);
        tdUnit.appendChild(unit);

        const tdSrc = document.createElement('td');
        tdSrc.textContent = r.source;

        const tdAct = document.createElement('td');
        tdAct.className = 'actions';
        const del = document.createElement('button');
        del.className = 'iconBtn';
        del.title = 'Ta bort';
        del.textContent = 'üóë';
        del.addEventListener('click', () => {
          state.rows = state.rows.filter(x => x !== r);
          renderTable();
        });
        tdAct.appendChild(del);

        tr.appendChild(tdName);
        tr.appendChild(tdQty);
        tr.appendChild(tdUnit);
        tr.appendChild(tdSrc);
        tr.appendChild(tdAct);

        elTbody.appendChild(tr);
      }
    }

    function openDrawer(){
      refreshDrawer();
      elOverlay.classList.add('open');
      elDrawer.classList.add('open');
      elOverlay.setAttribute('aria-hidden', 'false');
    }
    function closeDrawer(){
      elOverlay.classList.remove('open');
      elDrawer.classList.remove('open');
      elOverlay.setAttribute('aria-hidden', 'true');
    }

    function refreshDrawer(){
      const p = state.portions || 1;
      $('#co2Total').textContent = '‚Äî';
      $('#co2Per').textContent = '‚Äî';
      $('#energyDist').textContent = '‚Äî';
      $('#mealSize').textContent = state.size;

      $('#dSub').textContent = `${p} portioner ‚Ä¢ ${state.size}`;

      const hist = $('#histBox');
      hist.textContent = '';
      const arr = Array.isArray(state.meal.history) ? state.meal.history : [];
      if (arr.length === 0){
        hist.textContent = '‚Äî';
        return;
      }
      for (const h of arr){
        const div = document.createElement('div');
        div.style.padding = '10px 0';
        div.style.borderBottom = '1px solid var(--border)';
        div.textContent = `${h.date} ‚Ä¢ ${h.change}`;
        hist.appendChild(div);
      }
    }

    // Events
    elBack.addEventListener('click', () => history.back());

    window.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== elQ){
        e.preventDefault();
        elQ.focus();
      }
      if (e.key === 'Escape'){
        closeDrawer();
        closeHelp();
      }
    });

    elQ.addEventListener('input', () => {
      state.q = elQ.value;
      renderTable();
    });

    $('#addRow').addEventListener('click', () => {
      state.rows.unshift({
        id: 'x_' + Math.random().toString(16).slice(2),
        name: 'Ny ingrediens',
        qty: '1',
        unit: 'st',
        source: 'M√•ltid'
      });
      renderTable();
    });

    portionSel.addEventListener('change', () => {
      state.portions = parseInt(portionSel.value, 10) || 1;
      refreshDrawer();
    });

    sizeSel.addEventListener('change', () => {
      state.size = sizeSel.value;
      pillSize.textContent = state.size;
      refreshDrawer();
    });

    elClimateBtn.addEventListener('click', () => {
      openDrawer();
      setTab('climate');
    });

    elOverlay.addEventListener('click', closeDrawer);
    elDClose.addEventListener('click', closeDrawer);
    tabs.forEach(t => t.addEventListener('click', () => setTab(t.dataset.tab)));

    $('#saveText').addEventListener('click', () => {
      state.editsText.title = title.value.trim() || state.editsText.title;
      state.editsText.desc = desc.value;
      state.editsText.steps = steps.value;
      state.editsText.note = note.value;
      $('#textNote').textContent = 'Sparat (demo).';
    });

    saveBtn.addEventListener('click', () => {
      saveNote.textContent = 'Sparat (demo).';
      setTimeout(() => { saveNote.textContent = ''; }, 2200);
    });

    // Boot
    buildRows();
    renderHeader();
    renderText();
    renderTable();
    setTab('climate');
  </script>

</body>
</html>
